# 🚀 AI功能快速配置方案

> **最后更新**: 2025-01-12
> **适用版本**: v2.0.0
> **服务器**: crm

---

## 📋 功能清单检查

### ✅ 已完成功能
- [x] AI提示词数据库配置系统
- [x] PC端AI智能创建客户
- [x] 移动端AI智能识别客户
- [x] 菜单路由重构
- [x] DeepSeek和豆包服务集成
- [x] 数据库初始化脚本
- [x] 移动端pages.json配置
- [x] 创建客户API完整实现
- [x] Token认证自动处理

### 🎯 核心功能路径

#### PC端
```
客户管理 → AI智能创建 → Ctrl+V粘贴截图 → 开始AI识别 → 确认信息 → 创建客户
系统设置 → AI配置 → 选择场景 → 编辑提示词 → 保存配置
```

#### 移动端
```
客户页面 → 智能创建 → 拍照/相册 → 开始AI识别 → 确认信息 → 创建客户
```

---

## ⚡ 10分钟快速部署

### 步骤1：数据库配置（2分钟）

```bash
# 1. 连接到数据库
mysql -u root -p

# 2. 选择数据库
USE education_crm;

# 3. 执行初始化脚本
source D:\CC\1.1\database\ai_init.sql

# 4. 验证表创建
SHOW TABLES LIKE 'ai_prompt_configs';

# 5. 查看默认配置
SELECT scenario_key, scenario_name, model_provider
FROM ai_prompt_configs;
```

**预期输出**：
```
+-------------------------+----------------+----------------+
| scenario_key            | scenario_name  | model_provider |
+-------------------------+----------------+----------------+
| chat_deep_analysis      | 聊天深度分析    | deepseek       |
| chat_ocr_extract        | 聊天OCR识别    | doubao         |
| customer_recovery_script| 客户复苏话术   | deepseek       |
| customer_info_extract   | 客户信息提取   | deepseek       |
+-------------------------+----------------+----------------+
```

### 步骤2：配置环境变量（3分钟）

```bash
# 1. 进入后端目录
cd D:\CC\1.1\backend

# 2. 编辑.env文件（如果不存在则复制.env.example）
# Windows: notepad .env
# Linux: vim .env

# 3. 配置以下关键项：
```

**必须配置的环境变量**：

```env
# ========== DeepSeek配置 ==========
DEEPSEEK_API_KEY=sk-你的DeepSeek密钥
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# ========== 豆包配置 ==========
DOUBAO_API_KEY=你的豆包API_Key
DOUBAO_API_URL=https://ark.cn-beijing.volces.com/api/v3/chat/completions
DOUBAO_ENDPOINT_ID=ep-你的Endpoint_ID

# ========== 其他配置 ==========
AI_TIMEOUT=30000
AI_TEMPERATURE=0.3
AI_MAX_TOKENS=4000
```

**API Key获取地址**：
- DeepSeek: https://platform.deepseek.com/api_keys
- 豆包（火山方舟）: https://console.volcengine.com/ark/region:ark+cn-beijing/apiKey

### 步骤3：启动服务（3分钟）

#### 后端启动
```bash
cd D:\CC\1.1\backend
pnpm install  # 首次运行需要安装依赖
pnpm run start:dev
```

**验证后端**：访问 http://localhost:3000/api/ai-config
- 应该返回AI配置列表JSON

#### 前端启动
```bash
cd D:\CC\1.1\frontend
pnpm install  # 首次运行需要安装依赖
pnpm run dev
```

**验证前端**：访问 http://localhost:5173
- 登录后应能看到新的菜单结构

#### 移动端启动
```bash
cd D:\CC\1.1\mobile
pnpm install  # 首次运行需要安装依赖
pnpm run dev:h5
```

### 步骤4：配置权限（2分钟）

```sql
-- 为管理员角色添加AI功能权限（假设管理员角色ID=1）

-- 1. 查看现有权限
SELECT id, permission_key, permission_name
FROM permissions
WHERE permission_key LIKE '%ai%' OR permission_key LIKE '%smart%';

-- 2. 为管理员角色分配权限
INSERT INTO role_permissions (role_id, permission_id)
SELECT 1, id FROM permissions
WHERE permission_key IN ('system:ai-config', 'customer:smart-create')
ON DUPLICATE KEY UPDATE role_id=role_id;

-- 3. 验证权限分配
SELECT r.role_name, p.permission_name
FROM role_permissions rp
JOIN roles r ON rp.role_id = r.id
JOIN permissions p ON rp.permission_id = p.id
WHERE p.permission_key IN ('system:ai-config', 'customer:smart-create');
```

---

## 🧪 功能测试

### 测试1：AI配置管理
1. 登录系统
2. 进入 **系统设置** > **AI配置**
3. 左侧应显示场景列表（客户管理、聊天分析）
4. 点击 `chat_deep_analysis`
5. 切换DeepSeek/豆包供应商
6. 编辑提示词，点击保存
7. ✅ 应提示"保存成功"

### 测试2：PC端AI智能创建
1. 进入 **客户管理**
2. 点击 **AI智能创建** 按钮（绿色按钮）
3. 聚焦粘贴区域，按 `Ctrl+V` 粘贴聊天截图
4. 点击 **开始AI识别**
5. 等待10-30秒（显示进度）
6. 查看识别结果（4个Tab）
7. 修改信息（如需要）
8. 点击 **创建客户**
9. ✅ 应提示"客户创建成功"并刷新列表

### 测试3：移动端AI智能识别
1. 手机访问移动端H5
2. 进入客户页面
3. 点击 **智能创建** 或右上角"+"按钮
4. 选择 **拍照** 或 **相册**
5. 选择聊天截图（可多张）
6. 点击 **开始AI识别**
7. 查看识别结果（多个section）
8. 确认信息
9. 点击 **创建客户**
10. ✅ 应提示"客户创建成功"并返回列表

---

## 📊 配置参数详解

### DeepSeek配置

| 参数 | 说明 | 推荐值 | 调整建议 |
|------|------|--------|----------|
| API_KEY | DeepSeek密钥 | sk-xxx | 从官网获取 |
| API_URL | API地址 | 默认 | 无需修改 |
| MODEL | 模型名称 | deepseek-chat | 无需修改 |
| TEMPERATURE | 温度参数 | 0.3 | 提高=更创意，降低=更准确 |
| MAX_TOKENS | 最大Token | 4000 | 根据需要调整 |

### 豆包OCR配置

| 参数 | 说明 | 推荐值 | 调整建议 |
|------|------|--------|----------|
| API_KEY | 豆包密钥 | xxx | 从火山方舟获取 |
| API_URL | API地址 | 默认 | 无需修改 |
| ENDPOINT_ID | 端点ID | ep-xxx | 选择视觉模型端点 |
| TEMPERATURE | 温度参数 | 0.1 | OCR识别建议保持低温度 |
| MAX_TOKENS | 最大Token | 2000 | 根据识别量调整 |

### AI提示词场景配置

#### 场景1：chat_deep_analysis（聊天深度分析）
- **用途**：20+维度深度分析客户聊天记录
- **供应商**：DeepSeek
- **关键参数**：
  - temperature: 0.3（平衡准确性和多样性）
  - max_tokens: 4000（确保完整输出）
- **变量**：`{{chatText}}`, `{{customerName}}`, `{{customerPhone}}`, `{{customerIntent}}`

#### 场景2：chat_ocr_extract（聊天OCR识别）
- **用途**：识别聊天截图中的文字
- **供应商**：豆包（视觉模型）
- **关键参数**：
  - temperature: 0.1（最大化准确性）
  - max_tokens: 2000
- **变量**：无（直接识别图片）

#### 场景3：customer_recovery_script（客户复苏话术）
- **用途**：为沉睡客户生成复苏话术
- **供应商**：DeepSeek
- **关键参数**：
  - temperature: 0.7（提高创意性）
  - max_tokens: 500
- **变量**：`{{customerName}}`, `{{lastContactTime}}`, `{{needs}}`, `{{objections}}`

#### 场景4：customer_info_extract（客户信息提取）
- **用途**：从对话中提取结构化客户信息
- **供应商**：DeepSeek
- **关键参数**：
  - temperature: 0.2（确保准确提取）
  - max_tokens: 1000
- **变量**：`{{chatText}}`

---

## 🔧 常见问题处理

### Q1：AI识别失败，提示API Key错误
**原因**：环境变量未配置或配置错误
**解决**：
```bash
# 1. 检查.env文件
cat backend/.env | grep DEEPSEEK_API_KEY
cat backend/.env | grep DOUBAO_API_KEY

# 2. 确保没有your_前缀
# 错误示例：DEEPSEEK_API_KEY=your_deepseek_api_key_here
# 正确示例：DEEPSEEK_API_KEY=sk-abc123...

# 3. 重启后端服务
cd backend && pnpm run start:dev
```

### Q2：OCR识别不准确
**解决**：
1. 确保图片清晰，文字可见
2. 提高图片分辨率（建议1080p以上）
3. 调整豆包提示词（系统设置 > AI配置）
4. 检查`chat_ocr_extract`场景的temperature（建议0.1）

### Q3：客户信息提取不完整
**解决**：
1. 进入 **系统设置** > **AI配置**
2. 选择 `chat_deep_analysis` 场景
3. 调整系统提示词，增加更详细的指导
4. 降低temperature至0.2（提高准确性）
5. 增加max_tokens至5000（确保完整输出）

### Q4：移动端无法访问API
**检查**：
```bash
# 1. 确认mobile/.env配置
cat mobile/.env | grep VITE_API_BASE_URL

# 2. 应该指向后端地址
VITE_API_BASE_URL=http://your-server:3000/api

# 3. 确保后端允许跨域
# backend/.env中配置：
CORS_ORIGINS=http://your-mobile-url
```

### Q5：权限不足，无法访问AI配置
**解决**：
```sql
-- 检查当前用户的角色和权限
SELECT u.username, r.role_name, p.permission_name
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
JOIN role_permissions rp ON r.id = rp.role_id
JOIN permissions p ON rp.permission_id = p.id
WHERE u.id = <你的用户ID>;

-- 如果缺少权限，执行：
INSERT INTO role_permissions (role_id, permission_id)
SELECT <你的角色ID>, id FROM permissions
WHERE permission_key = 'system:ai-config';
```

---

## 📈 性能优化建议

### 1. AI响应速度优化
```env
# 减少timeout（加快失败反馈）
AI_TIMEOUT=20000

# 减少max_tokens（加快响应）
# 在AI配置中调整各场景的max_tokens
# 建议：2000-3000即可满足大部分需求
```

### 2. 图片处理优化
- **前端压缩**：上传前压缩图片至2MB以下
- **格式选择**：优先使用JPEG（比PNG小）
- **分辨率**：1080p足够，无需4K

### 3. 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_ai_configs_active ON ai_prompt_configs(is_active, scenario_category);

-- 定期清理无效配置
DELETE FROM ai_prompt_configs WHERE is_active = 0 AND update_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 4. 缓存优化
```typescript
// 在AiCacheService中调整缓存时间
private readonly defaultTTL = 1800000; // 30分钟
```

---

## 🔐 安全加固建议

### 1. API Key安全
```bash
# 切勿将API Key提交到代码仓库
echo ".env" >> .gitignore

# 使用环境变量管理
export DEEPSEEK_API_KEY="sk-xxx"
export DOUBAO_API_KEY="xxx"
```

### 2. 接口限流
```typescript
// 在Controller中添加限流（可选）
@UseGuards(ThrottlerGuard)
@Throttle(10, 60) // 每60秒最多10次请求
@Post('smart-create')
async smartCreate() { }
```

### 3. 数据脱敏
```typescript
// 日志中脱敏敏感信息
this.logger.log(`客户手机号: ${phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')}`);
```

### 4. 权限细化
```sql
-- 为不同角色分配不同的AI权限
-- 销售：只能使用智能创建
-- 管理员：可以配置AI提示词

INSERT INTO permissions (permission_key, permission_name, permission_group)
VALUES
  ('ai:smart-create:use', '使用智能创建', 'AI功能'),
  ('ai:config:edit', '编辑AI配置', 'AI功能'),
  ('ai:config:view', '查看AI配置', 'AI功能');
```

---

## 📞 故障联系流程

### 紧急问题（影响业务）
1. **检查日志**：`backend/logs/error.log`
2. **重启服务**：`pnpm run start:dev`
3. **联系技术支持**：提供错误日志和复现步骤

### 非紧急问题
1. **查阅文档**：`AI功能完整部署方案.md`
2. **搜索相似问题**：GitHub Issues
3. **提交Issue**：附带详细信息

### 日志收集
```bash
# 收集完整日志
cd backend
tail -n 500 logs/error.log > error_report.log
tail -n 500 logs/combined.log > combined_report.log

# 打包发送
tar -czf logs_$(date +%Y%m%d).tar.gz error_report.log combined_report.log
```

---

## ✅ 配置完成检查清单

### 数据库
- [ ] `ai_prompt_configs`表已创建
- [ ] 4个默认场景配置已插入
- [ ] 权限表已更新
- [ ] 可以查询到配置数据

### 环境变量
- [ ] `DEEPSEEK_API_KEY`已配置（无your_前缀）
- [ ] `DOUBAO_API_KEY`已配置
- [ ] `DOUBAO_ENDPOINT_ID`已配置
- [ ] 后端服务启动无错误

### 前端
- [ ] 菜单中可见"AI配置"
- [ ] 客户列表有"AI智能创建"按钮
- [ ] 点击按钮可打开对话框
- [ ] 粘贴图片功能正常

### 移动端
- [ ] `pages.json`已注册smart-create页面
- [ ] 可以通过路由访问智能创建页面
- [ ] 拍照/相册选择正常
- [ ] API调用自动携带token

### 功能测试
- [ ] PC端Ctrl+V粘贴截图成功
- [ ] AI识别返回结构化数据
- [ ] 创建客户成功
- [ ] 移动端拍照识别成功
- [ ] 移动端创建客户成功

### 权限
- [ ] 管理员可以访问AI配置
- [ ] 销售可以使用智能创建
- [ ] 权限控制生效

---

## 🎉 配置成功！

如果所有检查项都已完成，恭喜您成功配置了AI功能！

**下一步**：
1. 培训团队使用新功能
2. 收集使用反馈
3. 持续优化AI提示词
4. 监控AI使用量和成本

**持续改进**：
- 每周review AI分析结果
- 根据实际情况调整提示词
- 关注AI模型更新
- 收集用户反馈并优化

---

**文档版本**: v2.0.0
**最后更新**: 2025-01-12
**维护**: Claude Code
**技术支持**: GitHub Issues
