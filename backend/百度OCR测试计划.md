# 百度OCR测试计划

## 📋 测试目标

验证百度OCR相比豆包OCR在微信聊天截图识别中的准确率提升，目标从60-70%提升至85-90%。

---

## 🧪 测试准备

### 1. 环境准备

**数据库配置：**
```bash
# 方式一：使用导入脚本
cd backend
import-baidu-ocr-config.bat [数据库名] [用户名] [密码]

# 方式二：手动执行SQL
mysql -u root -p your_database < add-secret-key-to-ai-api-keys.sql
mysql -u root -p your_database < insert-ocr-provider-config.sql
mysql -u root -p your_database < insert-baidu-ocr-config.sql
```

**验证配置：**
```sql
-- 1. 检查百度OCR密钥配置
SELECT * FROM ai_api_keys WHERE provider = 'baidu';

-- 2. 检查OCR提供商配置
SELECT * FROM business_config WHERE config_key = 'ocr_provider';
```

### 2. 准备测试图片

准备10张不同复杂度的微信聊天截图：

| 编号 | 图片类型 | 测试重点 | 难度 |
|------|----------|----------|------|
| test-01.png | 简单对话 | 基础识别能力 | ⭐ |
| test-02.png | 含数字订单号 | 数字"0"识别 | ⭐⭐ |
| test-03.png | 产品名称 | 复杂字符识别 | ⭐⭐⭐ |
| test-04.png | 价格和金额 | 数字和符号混合 | ⭐⭐ |
| test-05.png | 长文本消息 | 长段落识别 | ⭐⭐ |
| test-06.png | 表情符号混合 | 特殊字符处理 | ⭐⭐⭐ |
| test-07.png | 低质量截图 | 模糊图片识别 | ⭐⭐⭐⭐ |
| test-08.png | 多行对话 | 复杂布局 | ⭐⭐⭐ |
| test-09.png | 含链接和@符号 | 特殊格式 | ⭐⭐ |
| test-10.png | 综合场景 | 全面测试 | ⭐⭐⭐⭐ |

---

## 🔬 测试步骤

### 阶段一：豆包OCR基线测试

**1. 配置豆包OCR**
```sql
UPDATE business_config
SET config_value = 'doubao'
WHERE config_key = 'ocr_provider';
```

**2. 执行识别测试**

针对每张测试图片：
1. 登录系统 → AI话术助手
2. 上传测试图片
3. 等待OCR识别完成
4. 记录识别结果

**3. 记录数据**

使用以下表格记录：

| 图片编号 | 实际文字内容 | OCR识别结果 | 错误字符数 | 准确率 | 主要错误类型 |
|---------|-------------|------------|-----------|--------|-------------|
| test-01 |             |            |           |        |             |
| test-02 |             |            |           |        |             |
| ...     |             |            |           |        |             |

**准确率计算公式：**
```
准确率 = (正确字符数 / 总字符数) × 100%
```

---

### 阶段二：百度OCR对比测试

**1. 切换到百度OCR**
```sql
UPDATE business_config
SET config_value = 'baidu'
WHERE config_key = 'ocr_provider';
```

**2. 验证服务切换**

查看后端日志，应看到：
```
[AiChatService] 使用百度OCR服务
[BaiduOcrService] 使用数据库中的百度OCR配置
```

**3. 执行相同测试**

使用完全相同的10张图片重复测试流程。

**4. 记录数据**

| 图片编号 | 实际文字内容 | OCR识别结果 | 错误字符数 | 准确率 | 主要错误类型 |
|---------|-------------|------------|-----------|--------|-------------|
| test-01 |             |            |           |        |             |
| test-02 |             |            |           |        |             |
| ...     |             |            |           |        |             |

---

### 阶段三：性能测试

**1. 识别速度对比**

记录每张图片的识别耗时：

| 图片编号 | 豆包OCR耗时(ms) | 百度OCR耗时(ms) | 性能差异 |
|---------|----------------|----------------|---------|
| test-01 |                |                |         |
| test-02 |                |                |         |
| ...     |                |                |         |

**2. 并发测试**

同时上传5张图片，记录：
- 总耗时
- 是否有请求失败
- 平均响应时间

---

## 📊 数据分析

### 1. 准确率对比

```
豆包OCR平均准确率 = (所有测试图片准确率之和) / 10
百度OCR平均准确率 = (所有测试图片准确率之和) / 10
准确率提升 = 百度OCR平均准确率 - 豆包OCR平均准确率
```

**预期结果：**
- 豆包OCR：60-70%
- 百度OCR：85-90%
- 提升幅度：15-25%

### 2. 错误类型分析

统计两种OCR的常见错误：

| 错误类型 | 豆包OCR出现次数 | 百度OCR出现次数 | 改进程度 |
|---------|----------------|----------------|---------|
| 数字"0"识别为字母"O" |   |   |         |
| 复杂字符错误 |   |   |         |
| 漏识别字符 |   |   |         |
| 多识别字符 |   |   |         |
| 顺序错误 |   |   |         |

### 3. 成本分析

假设每天处理100张图片：

```
豆包OCR月成本 = 100 × 30 × 豆包单价
百度OCR月成本 = 100 × 30 × 百度单价
成本增加 = 百度OCR月成本 - 豆包OCR月成本
```

**评估ROI：**
```
准确率提升带来的价值 vs 成本增加
```

---

## ✅ 验收标准

### 必须达成：
- ✅ 百度OCR平均准确率 ≥ 85%
- ✅ 相比豆包OCR准确率提升 ≥ 15%
- ✅ 数字"0"识别准确率 ≥ 95%
- ✅ 响应时间 ≤ 3秒
- ✅ 无系统错误或崩溃

### 可选目标：
- 🎯 百度OCR平均准确率 ≥ 90%
- 🎯 复杂字符识别准确率 ≥ 90%
- 🎯 响应时间 ≤ 2秒

---

## 🐛 问题排查

### 常见问题处理

**1. 提示"access_token invalid"**

**检查步骤：**
```sql
-- 查看当前配置
SELECT provider, api_key, secret_key FROM ai_api_keys WHERE provider = 'baidu';
```

**解决方案：**
- 确认API Key和Secret Key正确
- 登录百度云控制台验证密钥状态
- 检查是否开通"通用文字识别-高精度版"服务

**2. 识别结果为空**

**检查步骤：**
- 查看后端日志中的详细错误信息
- 确认图片格式（支持PNG、JPG）
- 检查图片大小（不超过4MB）

**解决方案：**
```typescript
// 临时添加调试日志
// baidu-ocr.service.ts:extractTextFromImage()
this.logger.debug(`图片路径: ${imagePath}`);
this.logger.debug(`图片Base64长度: ${imageBase64.length}`);
this.logger.debug(`API响应: ${JSON.stringify(response.data)}`);
```

**3. 切换OCR服务不生效**

**检查步骤：**
```sql
-- 1. 确认配置值
SELECT config_value FROM business_config WHERE config_key = 'ocr_provider';

-- 2. 查看最后更新时间
SELECT config_value, update_time FROM business_config WHERE config_key = 'ocr_provider';
```

**解决方案：**
- 等待1分钟让缓存过期
- 或重启后端服务强制刷新

---

## 📈 测试报告模板

### 测试报告

**测试时间：** YYYY-MM-DD
**测试人员：** [姓名]
**测试环境：** 开发/测试/生产

#### 一、测试概况

| 指标 | 豆包OCR | 百度OCR | 改进 |
|------|---------|---------|------|
| 平均准确率 | xx% | xx% | +xx% |
| 平均识别时间 | xxms | xxms | -xxms |
| 数字"0"准确率 | xx% | xx% | +xx% |
| 复杂字符准确率 | xx% | xx% | +xx% |

#### 二、详细测试结果

[粘贴详细测试数据表格]

#### 三、问题汇总

1. **严重问题：** [描述]
2. **一般问题：** [描述]
3. **优化建议：** [描述]

#### 四、结论和建议

**结论：**
- [ ] 达到验收标准，建议正式启用
- [ ] 部分达标，需要优化
- [ ] 未达标，需要进一步调整

**建议：**
1. [具体建议1]
2. [具体建议2]
3. [具体建议3]

---

## 🚀 下一步行动

### 如果测试通过：
1. ✅ 在生产环境执行数据库迁移
2. ✅ 配置百度OCR密钥
3. ✅ 灰度切换（先10%用户使用百度OCR）
4. ✅ 监控1周数据
5. ✅ 全量切换

### 如果测试未通过：
1. 🔍 分析失败原因
2. 🛠️ 优化图片预处理参数
3. 🧪 重新测试
4. 📊 评估其他OCR方案（如腾讯OCR、阿里OCR）

---

**测试文档版本：** v1.0.0
**最后更新：** 2025-11-22
