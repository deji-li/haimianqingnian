# 阶段式自动回访功能 - 验收测试指南

## ✅ 系统状态检查

### 服务运行状态
- ✅ **后端服务**: 运行中 (http://localhost:3000)
- ✅ **前端服务**: 运行中 (http://localhost:5174)
- ✅ **数据库**: MySQL 已连接
- ✅ **定时任务**: 已注册 (每天凌晨2点执行)

### 数据库表结构
- ✅ **auto_follow_configs**: 30条配置记录（6个意向度 × 5轮）
- ✅ **customers**: 已扩展4个字段
  - `auto_follow_enabled` (启用状态)
  - `auto_follow_round` (当前轮次)
  - `manual_follow_set` (手动设置标记)
  - `last_auto_follow_time` (上次自动计算时间)

---

## 📊 配置数据验证

### 6个意向度等级的默认配置

| 意向度 | 第1轮 | 第2轮 | 第3轮 | 第4轮 | 第5轮 |
|--------|-------|-------|-------|-------|-------|
| 极高   | 1天   | 3天   | 7天   | 15天  | 30天  |
| 高     | 3天   | 7天   | 15天  | 20天  | 30天  |
| 中     | 7天   | 15天  | 30天  | 30天  | 30天  |
| 低     | 15天  | 30天  | 60天  | 60天  | 60天  |
| 待评估 | 3天   | 7天   | 15天  | 30天  | 30天  |
| 成交   | 30天  | 60天  | 90天  | 180天 | 180天 |

✅ **数据库验证**: 所有30条配置记录已正确初始化

---

## 🧪 功能测试清单

### 1️⃣ 配置管理页面测试

**访问路径**: http://localhost:5174/system/auto-follow-config

#### 测试步骤：
1. **登录系统**
   - 用户名: `admin`
   - 密码: `admin123`

2. **进入配置页面**
   ```
   系统管理 → 自动回访配置
   ```

3. **查看配置说明**
   - ✅ 是否显示配置说明 Alert
   - ✅ 说明文字是否准确描述功能逻辑

4. **测试标签页切换**
   - ✅ 6个意向度标签（极高、高、中、低、待评估、成交）
   - ✅ 每个标签显示5轮配置
   - ✅ 数据正确加载

5. **测试单条配置编辑**
   - ✅ 修改某个间隔天数（例如：极高第1轮改为2天）
   - ✅ 点击"保存"按钮
   - ✅ 提示"保存成功"
   - ✅ 刷新页面，确认修改已持久化

6. **测试启用/禁用开关**
   - ✅ 点击某条配置的"禁用"按钮
   - ✅ 开关状态变为"禁用"
   - ✅ 提示"已禁用"

7. **测试批量保存**
   - ✅ 修改某个意向度的多条配置
   - ✅ 点击"批量保存【XXX】配置"按钮
   - ✅ 提示"【XXX】配置批量保存成功"

8. **测试恢复默认值**
   - ✅ 点击"恢复默认值"按钮
   - ✅ 弹出确认对话框
   - ✅ 确认后配置恢复到默认值
   - ✅ 提示"已恢复默认配置"

9. **测试保存所有配置**
   - ✅ 点击页面右上角"保存所有配置"按钮
   - ✅ 弹出确认对话框
   - ✅ 确认后提示"所有配置保存成功"

10. **测试时间线预览**
    - ✅ 选择不同意向度
    - ✅ 查看累计天数计算是否正确
    - ✅ 启用/禁用状态显示是否正确

**预期结果**: 所有配置操作流畅，数据保存正确，UI反馈及时

---

### 2️⃣ 客户详情页集成测试

**访问路径**: http://localhost:5174/customer/detail/:id

#### 测试步骤：

1. **查看自动回访状态显示**
   - ✅ "下次回访时间"字段是否显示
   - ✅ 是否显示"手动设置"或"自动计算"标签
   - ✅ "自动回访"开关状态是否正确
   - ✅ 当前轮次标签是否显示（例如：第2轮）
   - ✅ 鼠标悬停信息图标是否显示上次计算时间

2. **测试回访说明文字**
   - ✅ 手动设置时: "已手动设置回访时间,系统不再自动计算"
   - ✅ 自动启用时: "系统每天凌晨2点根据【XXX】配置自动计算下次回访时间"
   - ✅ 禁用时: "自动回访已禁用,需手动设置回访时间"

3. **测试启用/禁用自动回访**
   - ✅ 点击自动回访开关（启用→禁用）
   - ✅ 弹出确认对话框，文字说明正确
   - ✅ 确认后提示"已禁用自动回访"
   - ✅ 页面状态更新，说明文字变化
   - ✅ 再次点击（禁用→启用），验证反向操作

4. **测试手动设置回访时间**
   - ✅ 点击"添加跟进记录"
   - ✅ 设置"下次回访时间"
   - ✅ 提交后刷新客户详情
   - ✅ 确认显示"手动设置"标签
   - ✅ 确认轮次标记为"第1轮"
   - ✅ 确认说明文字变为"已手动设置回访时间"

**预期结果**: 状态显示准确，开关操作流畅，手动设置逻辑正确

---

### 3️⃣ 客户列表页集成测试

**访问路径**: http://localhost:5174/customer/list

#### 测试步骤：

1. **查看"下次回访时间"列显示**
   - ✅ 时间显示格式正确
   - ✅ 未设置时显示"未设置"（灰色文字）

2. **查看自动计算图标**
   - ✅ 自动计算的客户显示绿色刷新图标（Refresh）
   - ✅ 鼠标悬停显示"自动计算"提示

3. **查看手动设置图标**
   - ✅ 手动设置的客户显示灰色编辑图标（Edit）
   - ✅ 鼠标悬停显示"手动设置"提示

4. **查看轮次徽章**
   - ✅ 显示当前轮次（例如：R1, R2, R3...）
   - ✅ 样式为灰色info标签，plain效果
   - ✅ 仅在轮次>0时显示

5. **测试列表筛选和搜索**
   - ✅ 筛选出"自动回访启用"的客户
   - ✅ 筛选出"手动设置回访"的客户
   - ✅ 验证图标和徽章显示一致性

**预期结果**: 列表信息一目了然，图标和徽章准确反映客户回访状态

---

### 4️⃣ 后端API测试

使用Postman或curl进行API测试：

#### 4.1 获取所有配置
```bash
curl http://localhost:3000/api/auto-follow-config
```
✅ 返回30条配置记录

#### 4.2 获取分组配置
```bash
curl http://localhost:3000/api/auto-follow-config/grouped
```
✅ 按意向度分组返回

#### 4.3 获取指定意向度配置
```bash
curl http://localhost:3000/api/auto-follow-config/intent/极高
```
✅ 返回5条"极高"意向配置

#### 4.4 更新单条配置
```bash
curl -X PUT http://localhost:3000/api/auto-follow-config/1 \
  -H "Content-Type: application/json" \
  -d '{"daysInterval": 2, "isActive": 1}'
```
✅ 更新成功

#### 4.5 切换启用状态
```bash
curl -X PUT http://localhost:3000/api/auto-follow-config/1/toggle
```
✅ 状态切换成功

#### 4.6 批量更新
```bash
curl -X PUT http://localhost:3000/api/auto-follow-config/batch/极高 \
  -H "Content-Type: application/json" \
  -d '{
    "updates": [
      {"roundNumber": 1, "daysInterval": 1, "isActive": 1},
      {"roundNumber": 2, "daysInterval": 3, "isActive": 1}
    ]
  }'
```
✅ 批量更新成功

**预期结果**: 所有API端点正常响应，数据格式正确

---

### 5️⃣ 定时任务测试（手动触发）

由于定时任务在凌晨2点执行，可以通过以下方式验证：

#### 方法1: 查看后端日志
```bash
# 查看backend控制台输出
# 如果已经过了凌晨2点，应该能看到类似日志：
# [AutomationService] 开始执行自动回访时间更新任务...
# [AutomationService] 自动回访任务完成，更新X个客户
```

#### 方法2: 临时修改定时任务时间
1. 打开 `backend/src/modules/automation/automation.service.ts`
2. 找到第154行的 `@Cron('0 2 * * *')`
3. 临时改为当前时间后1分钟，例如：`@Cron('30 16 * * *')` (16:30执行)
4. 保存文件，等待webpack重新编译
5. 观察定时任务是否执行
6. **测试完毕后记得改回** `@Cron('0 2 * * *')`

#### 方法3: 直接调用Service方法（开发环境）
在backend控制台中添加临时测试端点来手动触发

**预期结果**: 定时任务执行，满足条件的客户的`nextFollowTime`被更新

---

### 6️⃣ 业务逻辑验证

#### 场景1: 新客户自动回访
1. ✅ 创建一个"极高"意向的新客户
2. ✅ 不手动设置回访时间
3. ✅ 确认 `auto_follow_enabled=1`, `manual_follow_set=0`, `auto_follow_round=0`
4. ✅ 等待定时任务执行（或手动触发）
5. ✅ 验证 `next_follow_time` 被设置为 创建时间 + 1天
6. ✅ 验证 `auto_follow_round=1`

#### 场景2: 手动设置回访时间
1. ✅ 选择一个自动回访客户
2. ✅ 添加跟进记录，手动设置下次回访时间
3. ✅ 确认 `manual_follow_set=1`
4. ✅ 确认 `auto_follow_round=1`
5. ✅ 等待定时任务执行
6. ✅ 验证该客户的回访时间**不会**被自动计算覆盖

#### 场景3: 轮次递进
1. ✅ 选择一个 `auto_follow_round=1` 的客户
2. ✅ 确保当前时间已超过 `last_auto_follow_time + 配置的间隔天数`
3. ✅ 等待定时任务执行
4. ✅ 验证 `auto_follow_round` 增加为 2
5. ✅ 验证 `next_follow_time` 使用第2轮的间隔天数计算

#### 场景4: 第5轮后持续使用第5轮间隔
1. ✅ 模拟一个 `auto_follow_round=5` 的客户
2. ✅ 等待定时任务执行
3. ✅ 验证 `auto_follow_round` 仍为 5（不会变成6）
4. ✅ 验证 `next_follow_time` 仍使用第5轮的间隔天数

#### 场景5: 禁用配置的影响
1. ✅ 在配置页面禁用"极高"第2轮
2. ✅ 验证处于第1轮的"极高"客户在定时任务执行后**不会**进入第2轮
3. ✅ 验证日志中有跳过记录

#### 场景6: 关闭自动回访
1. ✅ 在客户详情页关闭自动回访开关
2. ✅ 确认 `auto_follow_enabled=0`
3. ✅ 等待定时任务执行
4. ✅ 验证该客户的回访时间**不会**被自动计算

**预期结果**: 所有业务逻辑符合需求文档描述

---

## 🔍 快速验证命令

### 检查配置表数据
```sql
USE education_crm;
SELECT customer_intent, round_number, days_interval, is_active
FROM auto_follow_configs
ORDER BY customer_intent, round_number;
```

### 检查客户表扩展字段
```sql
USE education_crm;
DESC customers;
-- 查找 auto_follow_enabled, auto_follow_round, manual_follow_set, last_auto_follow_time
```

### 查看启用自动回访的客户
```sql
SELECT id, customer_name, customer_intent, auto_follow_enabled, auto_follow_round,
       manual_follow_set, next_follow_time, last_auto_follow_time
FROM customers
WHERE auto_follow_enabled = 1
LIMIT 10;
```

### 查看手动设置回访的客户
```sql
SELECT id, customer_name, customer_intent, manual_follow_set,
       auto_follow_round, next_follow_time
FROM customers
WHERE manual_follow_set = 1
LIMIT 10;
```

---

## 📝 已知注意事项

1. **定时任务执行时间**: 每天凌晨2点，需等待到该时间点才能看到自动计算效果
2. **手动设置优先**: 一旦手动设置回访时间，系统将停止自动计算，除非重新启用
3. **轮次上限**: 最多5轮，第5轮后继续使用第5轮间隔
4. **禁用配置**: 如果某轮配置被禁用，客户将跳过该轮
5. **Redis缓存**: 后端显示Redis未连接警告，这不影响自动回访功能（仅影响AI缓存）

---

## ✅ 验收标准

### 功能完整性
- ✅ 配置管理页面正常访问和操作
- ✅ 客户详情页正确显示自动回访状态
- ✅ 客户列表页正确显示状态图标和徽章
- ✅ 后端API端点全部可用
- ✅ 定时任务正确注册

### 数据准确性
- ✅ 30条配置记录正确初始化
- ✅ 客户表扩展4个字段
- ✅ 手动设置逻辑正确标记
- ✅ 轮次递进计算准确

### 用户体验
- ✅ UI提示信息清晰
- ✅ 操作反馈及时
- ✅ 状态显示直观
- ✅ 配置修改流畅

---

## 🎯 下一步建议

### 开发完成，建议进行以下操作：

1. **生产环境部署前检查**
   - 确认定时任务时间是否符合业务需求
   - 检查数据库备份策略
   - 验证配置数据的默认值是否需要调整

2. **用户培训**
   - 向销售人员说明自动回访的工作原理
   - 强调手动设置回访时间的优先级
   - 演示配置管理页面的使用

3. **监控建议**
   - 记录定时任务执行日志
   - 监控自动回访计算的成功率
   - 收集用户反馈进行优化

4. **功能增强（可选）**
   - 添加定时任务手动触发按钮（用于测试）
   - 增加自动回访历史记录查询
   - 支持按部门或销售定制配置
   - 添加回访提醒推送功能

---

## 📞 技术支持

如遇到问题，请检查：
1. 后端服务是否正常运行 (http://localhost:3000)
2. 前端服务是否正常运行 (http://localhost:5174)
3. MySQL数据库连接是否正常
4. 浏览器控制台是否有错误信息
5. 后端控制台日志是否有异常

**开发完成日期**: 2025-11-24
**系统版本**: 1.1.0
**功能状态**: ✅ 已完成，待验收测试
