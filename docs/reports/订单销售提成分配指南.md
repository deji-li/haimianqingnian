# 订单销售提成分配指南

## 🎉 财务模块打通成功！

**打通结果**：
- ✅ 6个订单全部计算完成
- ✅ 订单总金额：¥104,900
- ✅ 佣金总额：¥4,607
- ✅ 2名销售人员已分配提成

### 📊 销售人员提成分配明细

| 销售姓名 | 订单数 | 订单总额 | 佣金总额 |
|----------|--------|----------|----------|
| **赵销售** | 3 | ¥52,200 | ¥2,386 |
| **王销售** | 3 | ¥52,700 | ¥2,221 |

---

## 💡 如何设置后续订单的销售提成？

### 核心原理：通过 `sales_id` 字段关联

订单表中的 **`sales_id`** 字段决定了佣金归属于哪个销售人员。系统会自动：
1. 根据订单的 `order_tag`（订单标签）匹配佣金方案
2. 计算佣金金额
3. 将佣金记录到 `sales_id` 对应的销售人员名下

---

## 🔧 三种设置方式

### 方式一：创建订单时指定销售人员（推荐）⭐

**通过前端界面**：
1. 进入"订单管理" → "新建订单"
2. 在订单表单中，找到 **"销售人员"** 或 **"跟进人"** 字段
3. 从下拉列表中选择负责的销售人员
4. 填写其他订单信息（客户、金额、订单标签等）
5. 提交订单

**通过API创建**：
```bash
POST /api/order
Body: {
  "customerId": 1,
  "paymentAmount": 10000,
  "orderTag": "新签",        # 必须：用于匹配佣金方案
  "salesId": 4,              # 关键：指定销售人员ID
  "courseName": "高考冲刺班",
  ...
}
```

**当前可用的销售人员**：
```sql
-- 查询所有销售人员
SELECT id, real_name, username FROM users;
```

| ID | 姓名 | 用户名 |
|----|------|--------|
| 4 | 王销售 | (查看数据库) |
| 5 | 赵销售 | (查看数据库) |

---

### 方式二：修改现有订单的销售人员

**如果订单已创建但销售人员设置错误**：

**通过前端界面**：
1. 进入"订单管理" → 找到目标订单
2. 点击"编辑"
3. 修改"销售人员"字段
4. 保存

**通过API修改**：
```bash
PATCH /api/order/{订单ID}
Body: {
  "salesId": 5    # 改为新的销售人员ID
}
```

**通过SQL直接修改**：
```sql
-- 修改订单1的销售人员为赵销售(ID=5)
UPDATE orders
SET sales_id = 5
WHERE id = 1;

-- 如果订单已计算佣金，需要重新计算
-- 调用API: POST /api/commission/calculate/1
```

---

### 方式三：从客户关联自动继承（自动化）

**原理**：如果客户已经分配了跟进销售，创建订单时可以自动继承。

**实现方式**：
1. **客户表关联**：
   ```sql
   -- 客户表中的sales_id字段
   SELECT id, real_name, sales_id FROM customers;
   ```

2. **订单创建时自动填充**：
   - 后端代码可以在创建订单时，自动从客户表读取 `sales_id`
   - 如果未指定销售人员，使用客户的跟进销售

**参考代码逻辑**（后端 `order.service.ts`）：
```typescript
// 如果订单没有指定salesId，从客户继承
if (!createOrderDto.salesId && createOrderDto.customerId) {
  const customer = await this.customerRepository.findOne({
    where: { id: createOrderDto.customerId }
  });
  createOrderDto.salesId = customer?.salesId;
}
```

---

## 📋 完整业务流程示例

### 场景：赵销售接待新客户并签单

#### 1️⃣ 创建客户（指定跟进销售）
```sql
INSERT INTO customers (
  real_name, phone, wechat_id,
  sales_id,          # 关键：赵销售的ID = 5
  customer_intent,
  lifecycle_stage
) VALUES (
  '张三', '13800138000', 'wx_zhangsan',
  5,                 # 赵销售
  '高意向',
  '新客户'
);
```

#### 2️⃣ 创建订单（自动继承销售人员）
```sql
INSERT INTO orders (
  customer_id,
  order_no,
  payment_amount,
  order_tag,         # 必须：用于匹配佣金方案
  sales_id,          # 从客户继承或手动指定
  course_name,
  order_status
) VALUES (
  1,                 # 上一步创建的客户ID
  'ORD202501007',
  15000,
  '新签',           # 匹配"新签单提成-标准方案"(5%)
  5,                 # 赵销售
  '高考冲刺班',
  '已完成'
);
```

#### 3️⃣ 系统自动计算佣金
- 订单保存后，系统自动调用佣金计算
- 根据 `order_tag="新签"` 匹配到"新签单提成-标准方案"（5%）
- 佣金金额：15000 × 5% = ¥750
- 佣金记录到 `sales_id=5`（赵销售）名下

#### 4️⃣ 查看赵销售的佣金
```sql
SELECT
    cc.id,
    o.order_no AS '订单号',
    cc.order_amount AS '订单金额',
    cc.commission_amount AS '佣金金额',
    cc.status AS '状态'
FROM commission_calculations cc
LEFT JOIN orders o ON o.id = cc.order_id
WHERE cc.sales_id = 5    -- 赵销售
ORDER BY cc.create_time DESC;
```

---

## 🎯 重要字段说明

### 订单表（orders）关键字段

| 字段名 | 说明 | 示例值 | 影响 |
|--------|------|--------|------|
| **sales_id** | 销售人员ID（外键） | 4, 5 | **决定佣金归属** |
| **order_tag** | 订单标签 | "新签", "续费" | 匹配佣金方案 |
| **payment_amount** | 订单金额 | 15000.00 | 计算佣金基数 |
| **commission_scheme_id** | 佣金方案ID | 1, 2 | 系统自动填充 |
| **commission_amount** | 佣金金额 | 750.00 | 系统自动计算 |

### 佣金方案匹配规则

| 佣金方案 | 匹配条件 | 佣金比例/金额 |
|----------|----------|---------------|
| 新签单提成-标准方案 | order_tag="新签" | 5% |
| 续费单提成-标准方案 | order_tag="续费" | 3% |
| 高额订单提成-阶梯方案 | 金额分档 | 4%-6% |
| 高考冲刺班-固定提成 | 特定课程 | ¥800固定 |

---

## ✅ 验证销售提成设置

### 查看所有销售人员的提成统计
```sql
SELECT
    u.id AS '销售ID',
    u.real_name AS '销售姓名',
    COUNT(cc.id) AS '订单数',
    SUM(cc.order_amount) AS '订单总额',
    SUM(cc.commission_amount) AS '佣金总额',
    SUM(CASE WHEN cc.status='pending' THEN cc.commission_amount ELSE 0 END) AS '待结算',
    SUM(CASE WHEN cc.status='paid' THEN cc.commission_amount ELSE 0 END) AS '已结算'
FROM commission_calculations cc
LEFT JOIN users u ON u.id = cc.sales_id
GROUP BY u.id, u.real_name
ORDER BY SUM(cc.commission_amount) DESC;
```

### 查看单个销售的详细提成
```sql
-- 查看赵销售(ID=5)的提成明细
SELECT
    o.order_no AS '订单号',
    o.payment_amount AS '订单金额',
    cc.scheme_name AS '佣金方案',
    cc.commission_amount AS '佣金金额',
    cc.status AS '状态',
    cc.create_time AS '创建时间'
FROM commission_calculations cc
LEFT JOIN orders o ON o.id = cc.order_id
WHERE cc.sales_id = 5
ORDER BY cc.create_time DESC;
```

---

## 🔍 常见问题

### Q1: 如果订单没有设置sales_id会怎样？
**A**: 佣金计算仍会执行，但 `commission_calculations` 表中的 `sales_id` 为空，无法归属到具体销售人员。

**解决方法**：
- 订单创建时强制要求填写销售人员
- 或从客户表自动继承

### Q2: 一个订单可以分配给多个销售吗？
**A**: 当前设计是一对一关系（一个订单对应一个主要销售）。

**如需多人分成**：
- 可以扩展 `commission_calculations` 表
- 为同一个订单创建多条佣金记录
- 每条记录对应不同的销售人员和分成比例

### Q3: 修改订单的sales_id后，佣金会自动更新吗？
**A**: 不会自动更新。需要：
1. 修改订单的 `sales_id`
2. 重新调用佣金计算API：`POST /api/commission/calculate/{订单ID}`

### Q4: 如何查看某个销售的总提成？
**A**: 使用上面的"查看所有销售人员的提成统计"SQL，或通过API：
```bash
GET /api/commission/summary/user
```

### Q5: 新增销售人员后如何使用？
**A**:
1. 在 `users` 表中添加新销售人员记录
2. 创建订单时在 `sales_id` 字段中选择该销售人员
3. 系统会自动将佣金分配给该销售

---

## 📝 快速参考

### 查询所有可用销售人员
```sql
SELECT id, real_name, username FROM users;
```

### 创建订单时指定销售（前端示例）
```javascript
// Vue组件中
const createOrder = async () => {
  const orderData = {
    customerId: selectedCustomer.value,
    paymentAmount: 10000,
    orderTag: '新签',      // 必须
    salesId: 5,            // 赵销售
    courseName: '高考冲刺班',
    orderStatus: '已完成'
  };

  await orderApi.create(orderData);
};
```

### 修改订单销售人员（API）
```bash
PATCH /api/order/1
Body: { "salesId": 5 }
```

### 重新计算佣金（API）
```bash
POST /api/commission/calculate/1
```

---

## 🎯 总结

**关键点**：
1. ✅ 订单的 `sales_id` 字段决定佣金归属
2. ✅ `order_tag` 字段决定使用哪个佣金方案
3. ✅ 创建订单时必须指定销售人员
4. ✅ 系统会自动计算并分配佣金

**建议**：
- 在前端订单创建表单中，将"销售人员"设为必填项
- 考虑从客户表自动继承销售人员，减少重复输入
- 定期查看销售提成统计，确保分配正确

---

**文档版本**: v1.0
**更新时间**: 2025-11-24
**状态**: ✅ 财务模块已打通，佣金系统正常运行
