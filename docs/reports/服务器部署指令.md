# 🚀 服务器部署指令

## ✅ 代码已推送到Git

所有代码已成功提交并推送到远程仓库：
- Commit: `966b7fe` - 添加服务器一键部署脚本
- Commit: `057802b` - 添加企业知识库完整系统

---

## 📋 服务器信息

- **服务器路径**：`/root/crm`
- **数据库容器**：`crm-mysql`
- **数据库名**：`education_crm`
- **部署方式**：Docker Compose

---

## 🎯 一键部署命令（直接复制执行）

### 方式一：完整命令（推荐）

SSH登录服务器后，复制粘贴以下命令：

```bash
cd /root/crm && git pull origin master && chmod +x deploy_knowledge.sh && ./deploy_knowledge.sh
```

### 方式二：分步执行

如果想分步查看每一步的结果：

```bash
# 1. 进入项目目录
cd /root/crm

# 2. 拉取最新代码
git pull origin master

# 3. 赋予执行权限
chmod +x deploy_knowledge.sh

# 4. 执行部署
./deploy_knowledge.sh
```

---

## ⏱️ 预计时间

- **代码拉取**：10秒
- **数据库更新**：30秒
- **前端构建**：2-3分钟
- **后端重启**：30秒
- **总计**：约 4-5分钟

---

## 📊 部署脚本会自动完成

1. ✅ 拉取最新代码
2. ✅ 执行数据库迁移（创建7个表 + 38个索引 + 200+行业问题 + 100条示例）
3. ✅ 构建前端项目
4. ✅ 重启后端Docker容器
5. ✅ 验证部署结果

---

## ✅ 部署成功的标志

看到以下信息表示部署成功：

```
✅ 部署完成！
========================================
📍 系统信息：
   前端目录：/root/crm/frontend/dist
   后端API：http://localhost:3000
   数据库：crm-mysql (education_crm)

📊 数据库统计：
   ✅ 7个知识库表已创建
   ✅ 38个性能索引已添加
   ✅ 200+行业问题已导入
```

---

## 🔍 部署后验证

### 1. 检查数据库（30秒）

```bash
docker exec -it crm-mysql mysql -uroot -p7821630lideji education_crm
```

执行SQL：
```sql
-- 查看知识库相关表
SHOW TABLES LIKE '%knowledge%';

-- 查看行业问题数量（应该返回200+）
SELECT COUNT(*) FROM industry_question_library;

-- 查看示例知识数量（应该返回100）
SELECT COUNT(*) FROM enterprise_knowledge_base;

-- 退出
exit;
```

### 2. 检查后端服务（10秒）

```bash
# 查看容器状态（backend应该是Up状态）
docker-compose ps

# 查看后端日志（应该没有ERROR）
docker-compose logs --tail=50 backend
```

### 3. 访问前端页面（1分钟）

访问以下页面，确认正常显示：

- ✅ `http://your-domain/knowledge/init` - 初始化向导
- ✅ `http://your-domain/knowledge/list` - 知识管理
- ✅ `http://your-domain/knowledge/search` - 智能搜索
- ✅ `http://your-domain/knowledge/mining` - AI挖掘
- ✅ `http://your-domain/knowledge/feedback` - 负反馈
- ✅ `http://your-domain/knowledge/statistics` - 使用统计

### 4. 功能测试（3分钟）

1. **初始化企业信息**
   - 访问 `/knowledge/init`
   - 填写企业基本信息
   - 完成4步向导

2. **创建测试知识**
   - 进入 `/knowledge/list`
   - 点击"新建知识"
   - 填写并保存

3. **测试智能搜索**
   - 进入 `/knowledge/search`
   - 搜索刚才创建的知识
   - 确认能找到结果

---

## ❌ 如果遇到问题

### 问题1：Git拉取失败

```bash
# 检查网络
ping github.com

# 查看远程仓库
git remote -v

# 强制拉取
git fetch --all
git reset --hard origin/master
```

### 问题2：数据库更新失败

```bash
# 检查数据库容器是否运行
docker ps | grep mysql

# 手动执行SQL
docker exec -i crm-mysql mysql -uroot -p7821630lideji education_crm < /root/crm/backend/database/update_all.sql
```

### 问题3：前端构建失败

```bash
cd /root/crm/frontend

# 清理并重新安装
rm -rf node_modules package-lock.json
npm install --ignore-scripts --legacy-peer-deps
npm run build
```

### 问题4：后端启动失败

```bash
# 查看详细日志
docker-compose logs backend

# 重启后端
docker-compose restart backend

# 重新构建并启动
docker-compose stop backend
docker-compose build backend
docker-compose up -d backend
```

---

## 📞 需要帮助？

1. 查看部署日志：脚本会输出详细的执行过程
2. 查看Docker日志：`docker-compose logs backend`
3. 查看数据库日志：`docker logs crm-mysql`
4. 检查Nginx配置：`nginx -t`

---

## 🎯 部署后配置

### 1. Nginx配置（如未配置）

编辑Nginx配置文件：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /root/crm/frontend/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

重启Nginx：
```bash
nginx -t && nginx -s reload
```

### 2. AI配置

访问系统后：
1. 进入"系统管理" > "AI配置"
2. 设置OpenAI或其他AI服务的API密钥
3. 确认知识库相关的AI场景已配置

---

## 📚 相关文档

部署完成后，可以在项目目录查看详细文档：

- `/root/crm/QUICK_START.md` - 快速开始指南
- `/root/crm/DEPLOYMENT_GUIDE.md` - 完整部署指南
- `/root/crm/backend/ENTERPRISE_KNOWLEDGE_FINAL_REPORT.md` - 功能说明

---

## 🎉 开始使用

部署成功后：

1. **完成初始化**
   - 访问 `/knowledge/init`
   - 按向导完成企业信息配置

2. **导入知识**
   - 可以选择导入行业问题库
   - 或手动创建企业专属知识

3. **体验功能**
   - 智能搜索：AI语义匹配
   - AI挖掘：自动从对话中提取知识
   - 负反馈：持续优化知识质量
   - 统计分析：掌握知识使用情况

---

**部署日期**：2025-11-17
**版本**：v1.0.0
**状态**：✅ 已准备好部署

祝您部署顺利！🚀
