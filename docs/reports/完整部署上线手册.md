# 海绵青年CRM系统 - 完整部署上线手册

## 📋 目录

- [系统功能总览](#系统功能总览)
- [部署前准备](#部署前准备)
- [详细部署步骤](#详细部署步骤)
- [部署后配置](#部署后配置)
- [功能验证清单](#功能验证清单)
- [常见问题排查](#常见问题排查)
- [回滚方案](#回滚方案)
- [性能监控](#性能监控)

---

## 📌 系统功能总览

### 完整功能清单（7大AI模块 + CRM核心功能）

#### ✅ AI智能助手模块

**1. AI聊天记录分析** (`/ai/chat-analysis`)
- 📸 上传微信聊天截图
- 🔍 豆包OCR自动识别聊天文字
- 🤖 DeepSeek AI进行20+维度智能分析
  - 客户质量等级（A/B/C/D）
  - 风险等级评估
  - 意向评分（0-100）
  - 客户画像（10个维度）
  - 需求痛点识别
  - 情绪态度分析
  - 成交预测
  - 销售策略建议
- 🏷️ 自动生成6类客户标签
- 📊 分析质量统计看板
- ⚠️ 自动创建风险预警

**2. AI知识库** (`/ai/knowledge`)
- 📚 知识条目管理（增删改查）
- 🔎 AI智能语义搜索
- 📁 分类管理（产品/政策/话术/案例等）
- 📥 批量导入功能
- 📊 使用次数统计
- ⭐ 收藏和分享功能

**3. AI工具中心** (`/ai/tools`)

**3.1 AI话术助手**
- 生成个性化销售话术
- 支持5种场景：
  - 开场白
  - 需求挖掘
  - 应对异议
  - 促成成交
  - 售后跟进
- 话术库管理（查看、使用、标记有效）
- 效果评分和使用统计

**3.2 AI风险预警**
- 自动识别客户流失风险
- 风险等级分类（低/中/高）
- 风险原因分析
- 推荐行动建议
- 预警处理跟踪

**3.3 AI客户复苏**
- 识别沉睡客户（可设置天数）
- 分析客户历史数据
- AI生成唤醒话术
- 一键复制使用

**3.4 AI培训陪练**
- 模拟真实销售场景
- 5种训练场景：
  - 首次接触客户
  - 需求挖掘
  - 价格谈判
  - 处理异议
  - 促成签单
- AI扮演客户角色
- 实时对话反馈
- 自动评分（沟通/响应/异议处理）
- 详细改进建议

**4. AI营销助手** (`/ai/marketing`) 🆕
- 生成6种营销文案：
  - 📱 朋友圈文案
  - 💬 微信群发文案
  - 🎵 抖音营销文案
  - 📖 小红书营销文案
  - 🎬 短视频拍摄脚本
  - 📰 公众号推文
- 支持客户画像输入
- 痛点、需求、兴趣分析
- 产品信息整合
- 生成、复制、重新生成功能
- 保存收藏功能

**5. AI人效分析看板** (`/ai/analytics`) 🆕
- 👥 销售人员AI使用排行榜
  - 总使用次数
  - A级线索数量
  - 转化率统计
  - 🥇🥈🥉奖牌显示
- 📊 客户质量分布（饼图）
- 📈 AI功能使用统计（柱状图）
- 🎯 转化漏斗分析（漏斗图）
- ⚠️ 风险预警统计
- 📅 日期范围筛选

**6. AI诊断报告** (`/ai/reports`) 🆕
- 生成3种报告类型：
  - 📅 周报
  - 📊 月报
  - 📈 季报
- 支持维度：
  - 个人
  - 团队
  - 全公司
- 报告内容：
  - 📋 关键指标统计
  - 💡 AI洞察发现
  - ⚠️ 问题诊断
  - 🎯 改进建议
- 异步生成（避免超时）
- 状态跟踪（生成中/已完成/失败）
- 报告列表和详情查看

**7. CRM统计页面** (`/crm-stats`) 🆕
- 📊 个人数据概览：
  - 总客户数
  - 本月新增客户
  - 总订单数
  - 本月新增订单
  - 订单总金额
  - 本月订单金额
- 📈 30天转化趋势图（折线图）
- 🎯 客户生命周期分布（饼图）
- 🌐 客户来源分布（饼图）
- 🤖 AI工具使用统计
  - 聊天分析次数
  - 培训陪练次数

#### ✅ CRM核心功能模块

**客户管理** (`/customer`)
- 客户列表（多维度筛选）
- 客户详情（完整信息）
- 客户跟进记录
- 客户标签管理
- 客户导入/导出
- 客户分配
- 客户公海

**订单管理** (`/order`)
- 订单创建
- 订单列表
- 订单详情
- 订单状态跟踪
- 支付管理
- 退款管理

**数据分析** (`/analytics`)
- 销售漏斗分析
- 客户来源分析
- 销售周期分析
- 高价值客户分析
- 转化趋势分析
- 收入预测
- 转化率多维分析

**团队管理**
- 团队排行榜
- 业绩统计
- 目标管理
- OKR管理

**财务管理** (`/finance`)
- 财务概览
- 提成管理
- 提成结算

**工作台** (`/workspace`)
- 待办事项
- 今日跟进
- 数据概览
- 快捷入口

---

## 🚀 部署前准备

### 1. 环境要求

**服务器要求：**
- 操作系统：Ubuntu 20.04+ / CentOS 7+
- CPU：2核及以上
- 内存：4GB及以上
- 硬盘：50GB及以上
- 网络：公网IP + 域名（可选）

**软件要求：**
- Docker：20.10+
- Docker Compose：1.29+
- Git：2.0+
- Nginx：1.18+（如需自定义配置）

### 2. API密钥准备

**必需的API密钥：**

#### 2.1 DeepSeek API密钥
- 用途：AI分析、文案生成、智能建议
- 获取地址：https://platform.deepseek.com
- 步骤：
  1. 注册/登录账号
  2. 进入"API Keys"页面
  3. 点击"创建新密钥"
  4. 复制密钥（格式：sk-xxxxxxxxxx）
- 费用：按调用量计费，新用户有免费额度

#### 2.2 豆包OCR API密钥
- 用途：识别微信聊天截图中的文字
- 获取地址：https://console.volcengine.com/ark
- 步骤：
  1. 注册/登录字节跳动火山引擎账号
  2. 进入"模型推理"
  3. 创建推理接入点
  4. 选择"豆包视觉模型"
  5. 获取API Key
- 费用：按调用量计费，有免费额度

### 3. GitHub配置检查

**确认GitHub Actions配置：**
- Repository：`deji-li/haimianqingnian`
- Secrets配置（Settings → Secrets and variables → Actions）：
  - `SERVER_HOST`：服务器IP
  - `SERVER_USER`：SSH用户名（通常是root）
  - `SERVER_SSH_KEY`：SSH私钥
  - `SERVER_PATH`：部署路径（/var/www/crm）

### 4. 本地代码检查

```bash
# 1. 检查Git状态
git status

# 2. 确认所有修改已提交
git log --oneline -5

# 3. 确认远程仓库配置
git remote -v
```

### 5. 数据备份（如果是更新部署）

**如果服务器已有数据，务必先备份：**

```bash
# SSH登录服务器
ssh root@你的服务器IP

# 备份数据库
cd /var/www/crm
docker exec crm-mysql mysqldump -uroot -p你的数据库密码 education_crm > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份上传文件
tar -czf uploads_backup_$(date +%Y%m%d_%H%M%S).tar.gz uploads/

# 备份.env配置文件
cp .env .env.backup
```

---

## 📦 详细部署步骤

### 方法一：使用一键部署脚本（推荐）

#### Windows系统：

```cmd
# 在项目根目录 D:\CC\1.1 下
双击运行：QUICK-DEPLOY.bat
```

脚本会自动执行：
1. ✅ 检查Git仓库
2. ✅ 显示当前状态
3. ✅ 添加所有文件到Git
4. ✅ 创建提交
5. ✅ 推送到GitHub
6. ✅ 触发自动部署
7. ✅ 显示部署进度链接

#### 脚本执行示例：

```
========================================
CRM System - Quick Deploy
========================================

This update includes:
  - AI Marketing Assistant (6 scenarios)
  - AI Efficiency Analytics Dashboard
  - AI Diagnostic Reports (Weekly/Monthly)
  - CRM Statistics Page

Deploy Method: GitHub Actions Auto Deploy

[1/4] Checking Git status...
On branch master
nothing to commit, working tree clean

[2/4] Adding files to Git...
Done

[3/4] Creating commit...
[master 0e3e35a] feat: Add AI Marketing Assistant, Analytics Dashboard, Diagnostic Reports and CRM Statistics module
 150 files changed, 8500 insertions(+), 120 deletions(-)
Done

[4/4] Pushing to GitHub (will trigger auto deploy)...
Enumerating objects: 200, done.
Counting objects: 100% (200/200), done.
Delta compression using up to 8 threads
Compressing objects: 100% (120/120), done.
Writing objects: 100% (150/150), 85.23 KiB | 8.52 MiB/s, done.
Total 150 (delta 80), reused 0 (delta 0)
To github.com:deji-li/haimianqingnian.git
   c4e3193..0e3e35a  master -> master

========================================
SUCCESS: Code pushed to GitHub!
========================================

Auto deployment will start...

View deployment progress:
   https://github.com/deji-li/haimianqingnian/actions

Deploy time: About 3-5 minutes

After deployment, you need to configure:
   1. SSH login to server
   2. Edit /var/www/crm/.env
   3. Add DEEPSEEK_API_KEY and DOUBAO_API_KEY
   4. Restart backend: docker-compose restart backend

See UPDATE-DEPLOYMENT.md for details
========================================

Open GitHub Actions now? (Y/N): Y
```

### 方法二：手动执行命令

#### 步骤1：推送代码到GitHub

```bash
# 1. 添加所有新文件和修改
git add .

# 2. 提交代码
git commit -m "feat: Add AI Marketing Assistant, Analytics Dashboard, Diagnostic Reports and CRM Statistics module"

# 3. 推送到GitHub（触发自动部署）
git push origin master
```

#### 步骤2：监控GitHub Actions部署

1. **访问Actions页面：**
   - URL: https://github.com/deji-li/haimianqingnian/actions
   - 查看最新的workflow运行状态

2. **部署流程说明（预计3-5分钟）：**

```
推送代码到GitHub
    ↓
GitHub Actions触发
    ↓
检出代码
    ↓
SSH连接到服务器
    ↓
拉取最新代码 (git pull)
    ↓
停止旧容器 (docker-compose down)
    ↓
重新构建镜像 (docker-compose build)
    ↓
启动新容器 (docker-compose up -d)
    ↓
等待服务就绪（30秒）
    ↓
健康检查
    ↓
部署完成 ✅
```

3. **查看实时日志：**

点击workflow运行记录 → 点击"Deploy"任务 → 展开步骤查看日志

#### 步骤3：验证部署结果

**SSH登录服务器检查：**

```bash
# 登录服务器
ssh root@你的服务器IP

# 进入项目目录
cd /var/www/crm

# 1. 查看容器状态（应该都是Up状态）
docker-compose ps

# 输出示例：
NAME                COMMAND                  SERVICE             STATUS              PORTS
crm-backend         "docker-entrypoint.s…"   backend             Up 2 minutes        0.0.0.0:3000->3000/tcp
crm-frontend        "/docker-entrypoint.…"   frontend            Up 2 minutes        0.0.0.0:80->80/tcp
crm-mysql           "docker-entrypoint.s…"   mysql               Up 2 minutes        0.0.0.0:3306->3306/tcp

# 2. 查看后端日志（检查是否有错误）
docker-compose logs -f backend --tail=50

# 3. 查看前端日志
docker-compose logs -f frontend --tail=20

# 4. 查看数据库日志
docker-compose logs -f mysql --tail=20
```

---

## ⚙️ 部署后配置

### 必需配置：添加API密钥

**SSH登录服务器：**

```bash
ssh root@你的服务器IP
cd /var/www/crm
```

**编辑环境变量文件：**

```bash
vim .env
```

**按 `i` 进入编辑模式，在文件末尾添加以下配置：**

```env
# ========================================
# DeepSeek AI 配置
# ========================================
# 用于AI洞察、文案生成、智能建议等功能
DEEPSEEK_API_KEY=sk-你的实际DeepSeek密钥
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# ========================================
# 豆包 OCR 配置
# ========================================
# 用于识别微信聊天截图中的文字
DOUBAO_API_KEY=你的实际豆包API密钥
DOUBAO_API_URL=https://ark.cn-beijing.volces.com/api/v3
DOUBAO_OCR_MODEL=doubao-vision-pro

# ========================================
# Redis 配置（如果未配置）
# ========================================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=redis123456
REDIS_DB=0
```

**保存并退出：**
- 按 `Esc`
- 输入 `:wq`
- 按 `Enter`

**重启后端服务：**

```bash
docker-compose restart backend
```

**验证配置生效：**

```bash
# 查看后端日志，确认没有API密钥错误
docker-compose logs -f backend --tail=50

# 应该看到类似输出：
# [Nest] 1  - 2025/01/07 10:30:25     LOG [NestApplication] Nest application successfully started
# [Nest] 1  - 2025/01/07 10:30:25     LOG [DeepseekAnalysisService] DeepSeek API initialized
```

### 可选配置：Redis缓存

**如果需要启用Redis缓存（推荐）：**

#### 方法1：使用Docker安装Redis

```bash
# 安装Redis容器
docker run -d \
  --name crm-redis \
  --network crm-network \
  -p 6379:6379 \
  -e REDIS_PASSWORD=redis123456 \
  redis:7-alpine \
  redis-server --requirepass redis123456

# 测试连接
docker exec -it crm-redis redis-cli -a redis123456 ping
# 输出：PONG
```

#### 方法2：系统安装Redis

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install redis-server

# CentOS
sudo yum install redis

# 启动Redis
sudo systemctl start redis
sudo systemctl enable redis
```

**配置Redis密码：**

```bash
sudo vim /etc/redis/redis.conf

# 找到并修改：
requirepass redis123456

# 重启Redis
sudo systemctl restart redis
```

**重启后端应用Redis配置：**

```bash
cd /var/www/crm
docker-compose restart backend
```

### 可选配置：MySQL性能优化

**如果数据量大，可以优化MySQL配置：**

```bash
# 创建MySQL配置文件
cat > /var/www/crm/mysql.cnf <<EOF
[mysqld]
# 内存优化
innodb_buffer_pool_size = 2G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 连接优化
max_connections = 500
max_connect_errors = 10000

# 查询优化
query_cache_type = 1
query_cache_size = 128M
query_cache_limit = 2M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
EOF

# 更新docker-compose.yml添加配置文件挂载
vim docker-compose.yml

# 在mysql服务的volumes下添加：
#   - ./mysql.cnf:/etc/mysql/conf.d/custom.cnf

# 重启MySQL
docker-compose restart mysql
```

---

## ✅ 功能验证清单

### 1. 基础服务验证

```bash
# SSH登录服务器
ssh root@你的服务器IP
cd /var/www/crm

# ✅ 检查1：容器状态
docker-compose ps
# 预期：3个容器都是Up状态

# ✅ 检查2：网络连通性
curl -I http://localhost
# 预期：HTTP/1.1 200 OK

curl -I http://localhost:3000
# 预期：HTTP/1.1 404 Not Found（正常，因为根路径不存在）

# ✅ 检查3：数据库连接
docker exec -it crm-mysql mysql -uroot -p你的数据库密码 -e "SHOW DATABASES;"
# 预期：看到 education_crm 数据库

# ✅ 检查4：查看数据库表
docker exec -it crm-mysql mysql -uroot -p你的数据库密码 education_crm -e "SHOW TABLES;"
# 预期：看到所有表，包括7个AI表：
# - ai_chat_records
# - ai_customer_tags
# - ai_knowledge_base
# - ai_scripts
# - ai_training_records
# - ai_risk_alerts
# - ai_reports
```

### 2. 前端页面验证

**在浏览器中访问系统：**
- URL: http://你的服务器IP 或 http://你的域名

#### ✅ 登录功能
- [ ] 能正常打开登录页面
- [ ] 输入账号密码能成功登录
- [ ] 登录后跳转到工作台

#### ✅ 导航菜单
- [ ] 侧边栏菜单正常显示
- [ ] 展开"AI智能助手"菜单，能看到：
  - AI聊天记录分析
  - AI知识库
  - AI工具中心
  - AI营销助手 🆕
  - AI人效分析 🆕
  - AI诊断报告 🆕
- [ ] 侧边栏能看到"CRM统计" 🆕

### 3. 新功能验证

#### ✅ AI营销助手 (`/ai/marketing`)

**验证步骤：**
1. [ ] 点击进入"AI营销助手"页面
2. [ ] 左侧看到6种内容类型：
   - 朋友圈文案
   - 微信群发文案
   - 抖音营销文案
   - 小红书营销文案
   - 短视频拍摄脚本
   - 公众号推文
3. [ ] 点击"朋友圈文案"
4. [ ] 在配置区输入：
   - 目标客户：小学家长
   - 年龄段：6-12岁
   - 产品名称：数学思维课
   - 勾选几个痛点/需求
5. [ ] 点击"生成文案"
6. [ ] 等待3-5秒，右侧显示生成的文案
7. [ ] 点击"复制文案"按钮
8. [ ] 点击"重新生成"能生成新的文案
9. [ ] 切换到其他内容类型，重复测试

**预期结果：**
- ✅ 能成功生成文案
- ✅ 文案内容合理、通顺
- ✅ 复制功能正常
- ✅ 重新生成功能正常

**如果出错：**
- 检查DeepSeek API密钥是否配置正确
- 查看后端日志：`docker-compose logs -f backend --tail=50`
- 查看浏览器控制台错误信息

#### ✅ AI人效分析 (`/ai/analytics`)

**验证步骤：**
1. [ ] 点击进入"AI人效分析"页面
2. [ ] 顶部看到4个统计卡片：
   - AI分析总次数
   - 高质量线索
   - 平均转化率
   - 待处理风险
3. [ ] 看到"销售人员AI使用排行"表格
   - 前3名有🥇🥈🥉奖牌
   - 显示使用次数、A级线索、转化率
4. [ ] 看到"客户质量分布"饼图
5. [ ] 看到"AI功能使用统计"柱状图
6. [ ] 看到"转化漏斗"漏斗图
7. [ ] 选择日期范围，数据会刷新

**预期结果：**
- ✅ 所有图表正常显示
- ✅ 数据结构合理
- ✅ 日期筛选功能正常

**注意：**
- 当前版本使用模拟数据显示界面
- 真实数据统计功能将在后续版本完善

#### ✅ AI诊断报告 (`/ai/reports`)

**验证步骤：**
1. [ ] 点击进入"AI诊断报告"页面
2. [ ] 点击"生成新报告"按钮
3. [ ] 在弹窗中选择：
   - 报告类型：周报
   - 报告周期：本周
   - 目标类型：个人
4. [ ] 点击"生成报告"
5. [ ] 看到报告列表中新增一条记录
   - 状态显示"生成中"
6. [ ] 等待10-20秒，刷新页面
7. [ ] 状态变为"已完成"
8. [ ] 点击"查看详情"
9. [ ] 看到完整的报告内容：
   - 关键指标统计
   - AI洞察发现
   - 问题诊断
   - 改进建议

**预期结果：**
- ✅ 能成功创建报告
- ✅ 异步生成过程正常
- ✅ 报告内容完整、合理
- ✅ AI生成的洞察和建议有价值

**如果报告一直"生成中"：**
- 查看后端日志是否有错误
- 检查DeepSeek API密钥和配额
- 检查网络连接

#### ✅ CRM统计 (`/crm-stats`)

**验证步骤：**
1. [ ] 点击侧边栏"CRM统计"
2. [ ] 顶部看到6个统计卡片：
   - 总客户数 / 本月新增
   - 总订单数 / 本月新增
   - 订单总金额 / 本月金额
3. [ ] 看到"30天转化趋势"折线图
4. [ ] 看到"客户生命周期分布"饼图
5. [ ] 看到"客户来源分布"饼图
6. [ ] 看到"AI工具使用"统计
   - 聊天分析次数
   - 培训陪练次数

**预期结果：**
- ✅ 所有统计数据正常显示
- ✅ 图表渲染正常
- ✅ 数据与实际业务相符

### 4. 原有功能验证

#### ✅ AI聊天记录分析 (`/ai/chat-analysis`)

**验证步骤：**
1. [ ] 进入"AI聊天记录分析"页面
2. [ ] 点击"上传聊天截图"
3. [ ] 选择一张微信聊天截图
4. [ ] 选择对应的客户
5. [ ] 点击"开始分析"
6. [ ] 等待分析完成（20-30秒）
7. [ ] 查看分析结果：
   - 质量等级（A/B/C/D）
   - 风险等级
   - 意向评分
   - 客户画像
   - 需求痛点
   - 跟进建议

**预期结果：**
- ✅ OCR识别准确
- ✅ AI分析完整
- ✅ 自动生成客户标签
- ✅ 如有风险，自动创建预警

**如果出错：**
- 检查豆包OCR API密钥
- 检查DeepSeek API密钥
- 确认截图格式（支持jpg、png）

#### ✅ AI知识库 (`/ai/knowledge`)

**验证步骤：**
1. [ ] 进入"AI知识库"页面
2. [ ] 点击"新增知识"
3. [ ] 填写标题、分类、内容
4. [ ] 保存成功
5. [ ] 使用智能搜索功能
6. [ ] 测试查看、编辑、删除

**预期结果：**
- ✅ 增删改查功能正常
- ✅ 智能搜索准确
- ✅ 分类管理正常

#### ✅ AI工具中心 (`/ai/tools`)

**验证步骤：**
1. [ ] 进入"AI工具中心"页面
2. [ ] 测试4个子工具：
   - **话术助手**：生成并使用话术
   - **风险预警**：查看和处理预警
   - **客户复苏**：识别沉睡客户
   - **培训陪练**：开始一次陪练

**预期结果：**
- ✅ 所有工具功能正常
- ✅ AI生成内容合理
- ✅ 操作流程顺畅

### 5. 性能验证

```bash
# ✅ 检查1：容器资源使用
docker stats --no-stream

# 预期：
# - CPU使用率 < 80%
# - 内存使用正常
# - 没有频繁重启

# ✅ 检查2：后端响应时间
time curl -I http://localhost:3000/api/customer
# 预期：响应时间 < 500ms

# ✅ 检查3：前端加载时间
# 在浏览器中按F12，查看Network面板
# 预期：首页加载时间 < 3秒
```

### 6. 权限验证

**使用不同角色账号登录测试：**

#### 管理员账号
- [ ] 能看到所有菜单
- [ ] 能访问所有AI功能
- [ ] 能看到AI人效分析

#### 销售人员账号
- [ ] 能看到自己的客户数据
- [ ] 能使用AI工具
- [ ] 能看到CRM统计

#### 销售主管账号
- [ ] 能看到团队数据
- [ ] 能生成团队报告
- [ ] 能看到团队排行

---

## 🔍 常见问题排查

### 问题1：部署失败

**症状：** GitHub Actions workflow显示失败

**排查步骤：**

```bash
# 1. 查看GitHub Actions日志
# 访问：https://github.com/deji-li/haimianqingnian/actions
# 点击失败的workflow，查看详细错误

# 2. 常见原因：
```

**A. SSH连接失败**
```bash
# 检查服务器SSH配置
ssh root@你的服务器IP

# 如果连接失败，检查：
# - 服务器IP是否正确
# - SSH端口是否开放（默认22）
# - 防火墙是否允许SSH
# - GitHub Secrets中的SSH密钥是否正确
```

**B. 磁盘空间不足**
```bash
# 检查磁盘空间
df -h

# 如果空间不足，清理Docker：
docker system prune -af
docker volume prune -f

# 清理旧的Git提交
cd /var/www/crm
git gc --aggressive --prune=now
```

**C. Docker服务未运行**
```bash
# 检查Docker状态
systemctl status docker

# 如果未运行，启动Docker
systemctl start docker
systemctl enable docker
```

**解决方案：**
- 修复上述问题后，重新推送代码触发部署
- 或在服务器上手动执行部署命令

### 问题2：容器无法启动

**症状：** `docker-compose ps` 显示容器状态不是Up

**排查步骤：**

```bash
cd /var/www/crm

# 1. 查看具体哪个容器有问题
docker-compose ps

# 2. 查看容器日志
docker-compose logs backend
docker-compose logs frontend
docker-compose logs mysql

# 3. 尝试重启
docker-compose restart

# 4. 如果还是不行，完全重建
docker-compose down
docker-compose up -d --build
```

**常见错误及解决：**

**A. MySQL容器启动失败**
```bash
# 错误：Can't connect to MySQL server
# 原因：数据库初始化失败或密码错误

# 解决：
docker-compose down -v  # 删除数据卷（会清空数据！）
docker-compose up -d mysql
docker-compose logs -f mysql

# 等待MySQL初始化完成（约30秒）
# 看到 "ready for connections" 表示成功
```

**B. 后端容器启动失败**
```bash
# 错误：Cannot connect to database
# 原因：数据库未就绪或配置错误

# 检查.env配置
cat .env | grep DB_

# 确保配置正确：
DB_HOST=mysql
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=你的密码
DB_DATABASE=education_crm

# 重启后端
docker-compose restart backend
```

**C. 前端容器启动失败**
```bash
# 查看详细错误
docker-compose logs frontend

# 如果是构建错误，重新构建
docker-compose build --no-cache frontend
docker-compose up -d frontend
```

### 问题3：AI功能报错

**症状：** AI功能使用时提示错误

**排查步骤：**

#### A. API密钥配置错误

```bash
# 1. 检查环境变量
docker exec crm-backend env | grep DEEPSEEK
docker exec crm-backend env | grep DOUBAO

# 2. 如果为空或错误，编辑.env
vim /var/www/crm/.env

# 3. 添加或修改配置
DEEPSEEK_API_KEY=sk-你的密钥
DOUBAO_API_KEY=你的密钥

# 4. 重启后端
docker-compose restart backend

# 5. 验证日志
docker-compose logs -f backend --tail=50
# 应该看到：[DeepseekAnalysisService] DeepSeek API initialized
```

#### B. API调用失败

```bash
# 1. 测试DeepSeek API连接
curl -X POST "https://api.deepseek.com/v1/chat/completions" \
  -H "Authorization: Bearer 你的DEEPSEEK密钥" \
  -H "Content-Type: application/json" \
  -d '{
    "model":"deepseek-chat",
    "messages":[{"role":"user","content":"test"}]
  }'

# 预期：返回JSON响应，包含content字段

# 2. 测试豆包OCR API
curl -X POST "https://ark.cn-beijing.volces.com/api/v3" \
  -H "Authorization: Bearer 你的DOUBAO密钥" \
  -H "Content-Type: application/json" \
  -d '{...}'

# 如果失败：
# - 检查密钥是否有效
# - 检查API配额是否用完
# - 检查网络连接
```

#### C. Redis缓存错误

```bash
# 如果后端日志显示Redis连接错误

# 1. 检查Redis是否运行
docker ps | grep redis
# 或
systemctl status redis

# 2. 如果未安装Redis，可以禁用缓存
# 编辑.env，注释掉Redis配置：
# REDIS_HOST=localhost
# REDIS_PORT=6379

# 3. 重启后端
docker-compose restart backend

# 注意：禁用Redis后，AI分析会较慢（因为无缓存）
```

### 问题4：前端页面404

**症状：** 访问新页面显示404

**排查步骤：**

```bash
# 1. 清除浏览器缓存
# 按 Ctrl+Shift+R 强制刷新

# 2. 检查前端容器
docker exec -it crm-frontend ls /usr/share/nginx/html

# 应该看到：index.html、assets等文件

# 3. 检查Nginx配置
docker exec -it crm-frontend cat /etc/nginx/conf.d/default.conf

# 应该包含：
# try_files $uri $uri/ /index.html;

# 4. 如果配置错误，重新构建前端
cd /var/www/crm
docker-compose build --no-cache frontend
docker-compose up -d frontend

# 5. 清除浏览器缓存后重试
```

### 问题5：数据库表不存在

**症状：** 后端日志显示"Table 'education_crm.ai_xxx' doesn't exist"

**解决方案：**

```bash
# 方法1：使用迁移脚本（推荐）
cd /var/www/crm
docker exec -i crm-mysql mysql -uroot -p你的密码 education_crm < backend/src/database/migrations/003-create-ai-tables.sql

# 方法2：进入MySQL手动执行
docker exec -it crm-mysql mysql -uroot -p你的密码

mysql> USE education_crm;
mysql> SOURCE /docker-entrypoint-initdb.d/05-ai-tables.sql;
mysql> SHOW TABLES;

# 应该看到7个AI表：
# - ai_chat_records
# - ai_customer_tags
# - ai_knowledge_base
# - ai_scripts
# - ai_training_records
# - ai_risk_alerts
# - ai_reports

mysql> EXIT;

# 3. 重启后端
docker-compose restart backend
```

### 问题6：上传文件失败

**症状：** 上传聊天截图或其他文件时失败

**排查步骤：**

```bash
# 1. 检查uploads目录权限
docker exec -it crm-backend ls -la /app/uploads

# 2. 如果权限不足，修复
docker exec -it crm-backend chmod -R 777 /app/uploads

# 3. 检查磁盘空间
df -h

# 4. 检查文件大小限制（Nginx）
docker exec -it crm-frontend cat /etc/nginx/nginx.conf | grep client_max_body_size

# 应该是：client_max_body_size 50M;

# 5. 如果需要修改，编辑Nginx配置后重启
docker-compose restart frontend
```

### 问题7：性能问题

**症状：** 页面加载慢、API响应慢

**优化方案：**

#### A. 数据库优化

```sql
-- 1. 检查慢查询
docker exec -it crm-mysql mysql -uroot -p你的密码

-- 查看慢查询日志
SHOW VARIABLES LIKE 'slow_query%';

-- 2. 添加索引（如果缺失）
USE education_crm;

-- 客户表索引
CREATE INDEX idx_customer_sales_lifecycle ON customers(sales_id, lifecycle_stage);
CREATE INDEX idx_customer_create ON customers(create_time);

-- 订单表索引
CREATE INDEX idx_order_customer_time ON orders(customer_id, payment_time);

-- AI表索引
CREATE INDEX idx_chat_customer ON ai_chat_records(customer_id);
CREATE INDEX idx_chat_quality ON ai_chat_records(quality_level);
CREATE INDEX idx_risk_customer ON ai_risk_alerts(customer_id, status);
```

#### B. 启用Redis缓存

参考"部署后配置"章节的Redis安装步骤

#### C. 增加服务器资源

```bash
# 如果资源不足，考虑：
# 1. 升级服务器配置（CPU、内存）
# 2. 使用负载均衡
# 3. 数据库读写分离
# 4. CDN加速静态资源
```

---

## 🔄 回滚方案

如果部署后发现严重问题，可以快速回滚：

### 方法1：回滚到上一个版本

```bash
# 1. SSH登录服务器
ssh root@你的服务器IP
cd /var/www/crm

# 2. 查看Git提交历史
git log --oneline -10

# 输出示例：
# 0e3e35a (HEAD) docs: Add Doubao OCR configuration
# b0928f9 feat: Add AI Marketing Assistant
# 2bb21b7 feat: Add AI features
# c4e3193 fix: 修复后端构建错误
# 45d45cf fix: 修复个人中心用户信息更新问题

# 3. 记录当前commit（以便恢复）
git rev-parse HEAD > rollback-from.txt

# 4. 回滚到上一个稳定版本
git reset --hard c4e3193

# 5. 停止容器
docker-compose down

# 6. 重新构建并启动
docker-compose build --no-cache
docker-compose up -d

# 7. 等待服务启动
sleep 30

# 8. 验证服务状态
docker-compose ps
curl -I http://localhost
```

### 方法2：使用备份恢复

```bash
# 如果回滚前做了数据备份

# 1. 停止服务
docker-compose down

# 2. 恢复数据库
docker-compose up -d mysql
sleep 20

docker exec -i crm-mysql mysql -uroot -p你的密码 education_crm < backup_20250107_100000.sql

# 3. 恢复上传文件
tar -xzf uploads_backup_20250107_100000.tar.gz

# 4. 恢复.env配置
cp .env.backup .env

# 5. 启动所有服务
docker-compose up -d

# 6. 验证
docker-compose ps
```

### 方法3：重新部署指定版本

```bash
# 从GitHub重新部署指定commit

cd /var/www/crm

# 1. 拉取指定版本
git fetch origin
git checkout c4e3193

# 2. 重新部署
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# 3. 验证
docker-compose ps
```

### 回滚后验证清单

- [ ] 所有容器正常运行
- [ ] 前端页面可访问
- [ ] 登录功能正常
- [ ] 核心功能可用
- [ ] 数据完整性检查

---

## 📊 性能监控

### 1. 容器监控

```bash
# 实时监控容器资源使用
docker stats

# 查看容器启动时间和重启次数
docker-compose ps

# 查看容器详细信息
docker inspect crm-backend
```

### 2. 日志监控

```bash
# 查看实时日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f mysql

# 查看最近N行日志
docker-compose logs --tail=100 backend

# 搜索错误日志
docker-compose logs backend | grep -i error
docker-compose logs backend | grep -i exception
```

### 3. 数据库监控

```sql
-- 进入MySQL
docker exec -it crm-mysql mysql -uroot -p你的密码

-- 查看连接数
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';

-- 查看慢查询统计
SHOW STATUS LIKE 'Slow_queries';

-- 查看表大小
USE education_crm;
SELECT
  table_name AS '表名',
  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS '大小(MB)'
FROM information_schema.TABLES
WHERE table_schema = 'education_crm'
ORDER BY (data_length + index_length) DESC;

-- 查看索引使用情况
SHOW INDEX FROM customers;
```

### 4. API性能监控

```bash
# 测试API响应时间
time curl -X GET "http://你的服务器IP/api/customer" \
  -H "Authorization: Bearer 你的JWT_TOKEN"

# 使用ab工具进行压力测试
ab -n 1000 -c 10 http://你的服务器IP/

# 使用hey工具
hey -n 1000 -c 10 http://你的服务器IP/
```

### 5. 系统资源监控

```bash
# CPU使用率
top

# 内存使用
free -h

# 磁盘使用
df -h

# 网络连接
netstat -ant | grep ESTABLISHED | wc -l

# IO统计
iostat -x 1
```

### 6. 设置告警（可选）

#### 使用简单的shell脚本监控

```bash
# 创建监控脚本
cat > /root/monitor-crm.sh <<'EOF'
#!/bin/bash

# 检查容器状态
CONTAINERS=$(docker-compose -f /var/www/crm/docker-compose.yml ps -q)
for CONTAINER in $CONTAINERS; do
  STATUS=$(docker inspect -f '{{.State.Status}}' $CONTAINER)
  if [ "$STATUS" != "running" ]; then
    echo "警告: 容器 $CONTAINER 状态异常: $STATUS"
    # 可以在这里添加发送邮件或钉钉通知
  fi
done

# 检查磁盘空间
DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
  echo "警告: 磁盘使用率 ${DISK_USAGE}%"
fi

# 检查API健康
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
if [ "$HTTP_CODE" != "200" ]; then
  echo "警告: API健康检查失败，状态码: $HTTP_CODE"
fi
EOF

chmod +x /root/monitor-crm.sh

# 添加到crontab，每5分钟执行一次
crontab -e
# 添加：
# */5 * * * * /root/monitor-crm.sh >> /var/log/crm-monitor.log 2>&1
```

---

## 📞 技术支持

### 遇到问题按以下顺序排查：

1. **查看本文档的常见问题章节** ✅
2. **查看系统日志**
   ```bash
   docker-compose logs -f backend --tail=100
   ```
3. **查看GitHub Actions日志**
   - https://github.com/deji-li/haimianqingnian/actions
4. **检查服务器资源**
   ```bash
   df -h
   docker stats
   free -h
   ```
5. **联系开发团队**
   - GitHub Issues: https://github.com/deji-li/haimianqingnian/issues

### 收集错误信息

如果需要技术支持，请提供以下信息：

```bash
# 1. 系统信息
cat > /tmp/crm-debug-info.txt <<EOF
=== 系统信息 ===
$(uname -a)
$(cat /etc/os-release)

=== Docker版本 ===
$(docker --version)
$(docker-compose --version)

=== 容器状态 ===
$(docker-compose -f /var/www/crm/docker-compose.yml ps)

=== 最近的后端日志 ===
$(docker-compose -f /var/www/crm/docker-compose.yml logs --tail=50 backend)

=== 最近的数据库日志 ===
$(docker-compose -f /var/www/crm/docker-compose.yml logs --tail=30 mysql)

=== 磁盘空间 ===
$(df -h)

=== 内存使用 ===
$(free -h)
EOF

cat /tmp/crm-debug-info.txt
```

---

## ✅ 部署完成检查清单

### 部署前检查

- [ ] 已准备DeepSeek API密钥
- [ ] 已准备豆包OCR API密钥
- [ ] 已确认GitHub Actions配置正确
- [ ] 已备份现有数据（如果是更新）
- [ ] 已测试SSH连接到服务器
- [ ] 服务器磁盘空间充足（>20GB）

### 部署中检查

- [ ] 代码已成功推送到GitHub
- [ ] GitHub Actions workflow执行成功
- [ ] 所有容器已启动（3个）
- [ ] 没有错误日志

### 部署后检查

- [ ] 前端页面可正常访问
- [ ] 可以成功登录系统
- [ ] DeepSeek API密钥已配置
- [ ] 豆包OCR API密钥已配置
- [ ] 7个AI数据库表已创建
- [ ] AI权限已配置
- [ ] 4个新功能页面可访问：
  - [ ] AI营销助手
  - [ ] AI人效分析
  - [ ] AI诊断报告
  - [ ] CRM统计
- [ ] 原有功能正常运行：
  - [ ] AI聊天记录分析
  - [ ] AI知识库
  - [ ] AI工具中心
  - [ ] 客户管理
  - [ ] 订单管理

### 功能验证

- [ ] AI营销助手能生成文案
- [ ] AI人效分析看板正常显示
- [ ] AI诊断报告能生成完成
- [ ] CRM统计数据正确
- [ ] 聊天分析OCR识别准确
- [ ] 知识库搜索正常
- [ ] 话术生成功能正常
- [ ] 风险预警功能正常

---

## 🎉 恭喜！

如果以上所有检查都通过，说明部署成功！

**系统现在包含：**
- ✅ 7大AI功能模块
- ✅ 完整的CRM管理功能
- ✅ 数据分析和报表
- ✅ 团队协作功能
- ✅ 智能营销助手
- ✅ 人效分析看板
- ✅ AI诊断报告系统
- ✅ 个人数据统计

**可以开始使用了！**

---

## 📝 附录

### A. 环境变量完整列表

```env
# 数据库配置
DB_HOST=mysql
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_secure_password
DB_DATABASE=education_crm
DB_SYNCHRONIZE=true
DB_LOGGING=false

# JWT认证
JWT_SECRET=your_jwt_secret_32_chars_min
JWT_EXPIRES_IN=7d

# DeepSeek AI
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxx
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# 豆包 OCR
DOUBAO_API_KEY=xxxxxxxxxxxxxxxxxx
DOUBAO_API_URL=https://ark.cn-beijing.volces.com/api/v3
DOUBAO_OCR_MODEL=doubao-vision-pro

# Redis缓存（可选）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=redis123456
REDIS_DB=0

# 应用配置
NODE_ENV=production
TZ=Asia/Shanghai
```

### B. 端口映射说明

| 服务 | 容器内端口 | 主机端口 | 说明 |
|------|-----------|---------|------|
| Frontend | 80 | 80 | Nginx前端服务 |
| Backend | 3000 | 3000 | NestJS后端API |
| MySQL | 3306 | 3306 | 数据库服务 |
| Redis | 6379 | 6379 | 缓存服务（可选） |

### C. 数据库表结构说明

**AI相关表（7个）：**
- `ai_chat_records` - 聊天分析记录
- `ai_customer_tags` - 客户标签
- `ai_knowledge_base` - 知识库
- `ai_scripts` - 话术库
- `ai_training_records` - 培训记录
- `ai_risk_alerts` - 风险预警
- `ai_reports` - 诊断报告

**CRM核心表：**
- `users` - 用户表
- `roles` - 角色表
- `permissions` - 权限表
- `customers` - 客户表
- `orders` - 订单表
- `follow_records` - 跟进记录表
- 等等...

### D. API端点速查表

**AI模块：**
- `POST /api/ai-chat/upload` - 上传聊天分析
- `POST /api/ai-knowledge/search` - 智能搜索
- `POST /api/ai-tools/script/generate` - 生成话术
- `GET /api/ai-tools/risk/pending` - 获取风险预警
- `POST /api/ai-tools/marketing/generate` - 生成营销文案
- `GET /api/ai-tools/analytics/efficiency` - 获取人效分析
- `POST /api/ai-tools/report/generate` - 生成诊断报告

**CRM模块：**
- `GET /api/customer` - 获取客户列表
- `POST /api/customer` - 创建客户
- `GET /api/order` - 获取订单列表
- `GET /api/analytics/*` - 各类数据分析

---

**文档版本：** v1.0.0
**最后更新：** 2025-01-07
**适用系统版本：** v2.0.0+

---

祝部署顺利！🚀
