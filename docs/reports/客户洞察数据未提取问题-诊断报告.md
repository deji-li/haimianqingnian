# å®¢æˆ·æ´å¯Ÿæ•°æ®æœªæå–é—®é¢˜ - è¯Šæ–­æŠ¥å‘Š

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šå®¢æˆ·è¯¦æƒ…é¡µä¸­çš„**å®¢æˆ·ç—›ç‚¹ã€å…´è¶£ç‚¹ã€éœ€æ±‚å…³é”®è¯**æ²¡æœ‰æ˜¾ç¤ºæ•°æ®

## âœ… å·²æ’æŸ¥é¡¹ç›®

### 1. æ•°æ®åº“è¡¨ç»“æ„ âœ…
- customersè¡¨ä¸­å­˜åœ¨å­—æ®µï¼š
  - `pain_points` (JSON)
  - `interest_points` (JSON)
  - `need_keywords` (JSON)

### 2. Entityå®šä¹‰ âœ…
```typescript
@Column({ name: 'pain_points', type: 'json', nullable: true })
painPoints: string[];

@Column({ name: 'interest_points', type: 'json', nullable: true })
interestPoints: string[];

@Column({ name: 'need_keywords', type: 'json', nullable: true })
needKeywords: string[];
```

### 3. AIåœºæ™¯é…ç½® âœ…
- `pain_point_analysis` - å·²å­˜åœ¨å¹¶æ¿€æ´»
- `interest_point_mining` - å·²å­˜åœ¨å¹¶æ¿€æ´»

### 4. ä»£ç é€»è¾‘ âœ…
`backend/src/modules/ai-chat/ai-chat.service.ts` ä¸­ï¼š
- ç¬¬224è¡Œï¼šè°ƒç”¨ `aiMarketingService.analyzePainPoints()`
- ç¬¬240è¡Œï¼šè°ƒç”¨ `aiMarketingService.mineInterestPoints()`
- ç¬¬265-266è¡Œï¼šä¿å­˜åˆ° ai_chat_records è¡¨
- ç¬¬275è¡Œï¼šè°ƒç”¨ `aggregateCustomerInsights()` èšåˆåˆ°å®¢æˆ·æ¡£æ¡ˆ

### 5. å®é™…æ•°æ® âŒ
```sql
SELECT id, pain_points, interest_points, need_keywords
FROM customers
WHERE pain_points IS NOT NULL OR interest_points IS NOT NULL;
-- è¿”å›ç©ºç»“æœ
```

## ğŸš¨ é—®é¢˜æ ¹å› åˆ†æ

### å¯èƒ½åŸå› 1ï¼šç—›ç‚¹/å…´è¶£ç‚¹æå–å¤±è´¥ä½†è¢«å¿½ç•¥
ä»£ç ä¸­æœ‰ try-catch åŒ…è£¹ï¼š
```typescript
try {
  painPointsResult = await this.aiMarketingService.analyzePainPoints(...);
  interestPointsResult = await this.aiMarketingService.mineInterestPoints(...);
} catch (error) {
  this.logger.warn(`æå–ç—›ç‚¹/å…´è¶£ç‚¹å¤±è´¥: ${error.message}`);
  // ä¸å½±å“ä¸»æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ  â† è¿™é‡Œé”™è¯¯è¢«å¿½ç•¥äº†ï¼
}
```

**åˆ†æ**ï¼šå³ä½¿æå–å¤±è´¥ï¼Œä¹Ÿä¼šç»§ç»­æ‰§è¡Œï¼Œç”¨æˆ·çœ‹ä¸åˆ°é”™è¯¯ã€‚

### å¯èƒ½åŸå› 2ï¼šAIè°ƒç”¨å¤±è´¥
- DeepSeek APIæœªé…ç½®æˆ–å¯†é’¥é”™è¯¯
- ç½‘ç»œé—®é¢˜å¯¼è‡´è°ƒç”¨è¶…æ—¶
- AIè¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ

### å¯èƒ½åŸå› 3ï¼šèšåˆé€»è¾‘æœ‰é—®é¢˜
`aggregateCustomerInsights()` æ–¹æ³•ï¼š
- éœ€è¦è‡³å°‘æœ‰ä¸€æ¡ `analysisStatus = 'å·²å®Œæˆ'` çš„èŠå¤©è®°å½•
- å¦‚æœæ²¡æœ‰èŠå¤©è®°å½•ï¼Œæˆ–è®°å½•çŠ¶æ€ä¸å¯¹ï¼Œä¸ä¼šèšåˆ

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¢å¼ºé”™è¯¯æ—¥å¿—ï¼ˆæ¨èï¼‰
ä¿®æ”¹ `ai-chat.service.ts` ç¬¬252è¡Œï¼š

**ä¿®æ”¹å‰**ï¼š
```typescript
catch (error) {
  this.logger.warn(`æå–ç—›ç‚¹/å…´è¶£ç‚¹å¤±è´¥: ${error.message}`);
  // ä¸å½±å“ä¸»æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
}
```

**ä¿®æ”¹å**ï¼š
```typescript
catch (error) {
  this.logger.error(`âŒ æå–ç—›ç‚¹/å…´è¶£ç‚¹å¤±è´¥: ${error.message}`, error.stack);
  this.logger.error(`è¯¦ç»†ä¿¡æ¯ - OCRæ–‡æœ¬é•¿åº¦: ${ocrText?.length}, å®¢æˆ·ID: ${customer.id}`);
  // ä¸å½±å“ä¸»æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
}
```

### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥AI APIé…ç½®
ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²æ­£ç¡®é…ç½®ï¼š
```env
# backend/.env.development
DEEPSEEK_API_KEY=sk-xxx...  # å¿…é¡»æ˜¯æœ‰æ•ˆçš„DeepSeek APIå¯†é’¥
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat
```

æˆ–åœ¨æ•°æ®åº“ä¸­é…ç½®ï¼š
```sql
SELECT provider, api_key, api_url FROM ai_api_keys WHERE provider = 'deepseek';
```

### æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨æµ‹è¯•ç—›ç‚¹æå–
åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯AIè°ƒç”¨ï¼š
```typescript
// test-pain-point-extraction.ts
const testText = `
[14:20] å®¢æˆ·ï¼šå­©å­æ•°å­¦æˆç»©ä¸€ç›´ä¸Šä¸å»ï¼Œå¾ˆç€æ€¥
[14:21] é”€å”®ï¼šäº†è§£ï¼Œå­©å­ç°åœ¨å‡ å¹´çº§å‘¢ï¼Ÿ
[14:22] å®¢æˆ·ï¼šå››å¹´çº§ï¼Œæ¯æ¬¡è€ƒè¯•éƒ½ä¸åŠæ ¼
`;

const result = await aiMarketingService.analyzePainPoints(testText, {
  wechatNickname: 'æµ‹è¯•å®¢æˆ·',
  customerIntent: 'ä¸­',
  studentGrade: 'å››å¹´çº§'
});

console.log('ç—›ç‚¹æå–ç»“æœï¼š', JSON.stringify(result, null, 2));
```

### æ–¹æ¡ˆ4ï¼šé™çº§æ–¹æ¡ˆ
å¦‚æœAIæå–ä¸€ç›´å¤±è´¥ï¼Œå¯ä»¥ä»DeepSeekèŠå¤©åˆ†æç»“æœä¸­æå–ï¼š

```typescript
// åœ¨ ai-chat.service.ts ä¸­
const analysisResult = await this.deepseekAnalysisService.analyzeChat(...);

// DeepSeekåˆ†æç»“æœä¸­å·²ç»åŒ…å«ç—›ç‚¹å’Œå…´è¶£ç‚¹
if (analysisResult.customerPainPoints) {
  extractedPainPoints = analysisResult.customerPainPoints;
}
if (analysisResult.customerInterests) {
  extractedInterestPoints = analysisResult.customerInterests;
}
```

## ğŸ“‹ éªŒè¯æ­¥éª¤

### æ­¥éª¤1ï¼šä¸Šä¼ èŠå¤©æˆªå›¾
1. ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥ é”€å”®å·¥å…· â†’ AIèŠå¤©åˆ†æ
3. ä¸Šä¼ ä¸€å¼ å¾®ä¿¡èŠå¤©æˆªå›¾

### æ­¥éª¤2ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—
åœ¨åç«¯æ§åˆ¶å°æŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—ï¼š
```
âœ… æˆåŠŸï¼šæå–ç—›ç‚¹ X ä¸ªï¼Œå…´è¶£ç‚¹ Y ä¸ª
âŒ å¤±è´¥ï¼šæå–ç—›ç‚¹/å…´è¶£ç‚¹å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
```

### æ­¥éª¤3ï¼šæŸ¥è¯¢æ•°æ®åº“
```sql
-- æŸ¥çœ‹èŠå¤©è®°å½•è¡¨
SELECT id, customer_id, pain_points, interest_points, analysis_status
FROM ai_chat_records
ORDER BY id DESC LIMIT 5;

-- æŸ¥çœ‹å®¢æˆ·è¡¨
SELECT id, wechat_nickname, pain_points, interest_points, need_keywords
FROM customers
WHERE id = [ä½ çš„å®¢æˆ·ID];
```

### æ­¥éª¤4ï¼šæ£€æŸ¥å‰ç«¯æ˜¾ç¤º
1. è¿›å…¥å®¢æˆ·è¯¦æƒ…é¡µ
2. æŸ¥çœ‹"å®¢æˆ·æ´å¯Ÿ"åŒºåŸŸ
3. ç¡®è®¤ç—›ç‚¹ã€å…´è¶£ç‚¹ã€éœ€æ±‚å…³é”®è¯æ˜¯å¦æ˜¾ç¤º

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**ï¼šä¿®æ”¹é”™è¯¯æ—¥å¿—çº§åˆ«ä¸º ERRORï¼ˆæ–¹æ¡ˆ1ï¼‰
2. **éªŒè¯**ï¼šæ£€æŸ¥DeepSeek APIé…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆæ–¹æ¡ˆ2ï¼‰
3. **æµ‹è¯•**ï¼šä¸Šä¼ èŠå¤©æˆªå›¾ï¼Œè§‚å¯Ÿåç«¯æ—¥å¿—
4. **ä¿®å¤**ï¼šæ ¹æ®æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯è¿›è¡Œé’ˆå¯¹æ€§ä¿®å¤

## ğŸ“Š é¢„æœŸç»“æœ

ä¿®å¤åï¼Œå½“ä¸Šä¼ èŠå¤©è®°å½•æ—¶åº”è¯¥çœ‹åˆ°ï¼š
1. åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š`æå–ç—›ç‚¹ 3 ä¸ªï¼Œå…´è¶£ç‚¹ 5 ä¸ª`
2. ai_chat_recordsè¡¨ï¼š`pain_points` å’Œ `interest_points` å­—æ®µæœ‰æ•°æ®
3. customersè¡¨ï¼šèšåˆåçš„ç—›ç‚¹å’Œå…´è¶£ç‚¹å·²ä¿å­˜
4. å‰ç«¯å®¢æˆ·è¯¦æƒ…é¡µï¼šå®¢æˆ·æ´å¯ŸåŒºåŸŸæ­£å¸¸æ˜¾ç¤º

---

**è¯Šæ–­æ—¶é—´**ï¼š2025-11-24
**çŠ¶æ€**ï¼šå¾…ä¿®å¤
**ä¼˜å…ˆçº§**ï¼šé«˜
