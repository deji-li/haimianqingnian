# 海绵订单同步功能测试文档

## 📋 目录

1. [功能概述](#功能概述)
2. [前置准备](#前置准备)
3. [测试环境配置](#测试环境配置)
4. [测试数据准备](#测试数据准备)
5. [测试步骤](#测试步骤)
6. [验收标准](#验收标准)
7. [常见问题排查](#常见问题排查)
8. [清理测试数据](#清理测试数据)

---

## 功能概述

### 业务背景

海绵订单同步功能用于将海绵青年GO系统的订单数据自动同步到本CRM系统中，帮助销售人员和运营人员统一管理来自不同渠道的订单数据。

### 核心功能

1. **手动触发同步**：在配置页面手动指定时间范围进行订单同步
2. **增量定时同步**：每5分钟自动同步最近7天的订单（可配置）
3. **每日批量更新**：每天凌晨2点批量更新最近30天的订单状态

### 技术架构

- **后端服务**：`order-sync.service.ts` - 核心同步逻辑
- **外部API调用**：`haimian-api.service.ts` - 海绵系统API集成
- **定时任务**：`order-sync.scheduler.ts` - 自动化同步任务
- **配置管理**：通过 `business_config` 表管理同步参数
- **日志记录**：`order_sync_logs` 表记录每次同步详情

---

## 前置准备

### 1. 数据库准备

确保已执行以下数据库迁移脚本：

```bash
# 订单同步相关表结构和配置
backend/src/migrations/1731575000000-AddOrderSyncFields.sql
```

验证表结构：

```sql
-- 检查 customers 表是否有 external_order_ids 字段
SHOW COLUMNS FROM customers LIKE 'external_order_ids';

-- 检查 orders 表是否有同步相关字段
SHOW COLUMNS FROM orders WHERE Field IN ('is_external', 'sync_status', 'data_source');

-- 检查同步日志表是否存在
SHOW TABLES LIKE 'order_sync_logs';

-- 检查业务配置是否存在
SELECT * FROM business_config WHERE category = 'order_sync';
```

### 2. 依赖包检查

确认后端已安装必需的npm包：

```bash
cd backend
npm list @nestjs/schedule
```

应该看到 `@nestjs/schedule@4.0.0` 或更高版本。

### 3. 模块注册验证

检查 `backend/src/app.module.ts` 是否已注册 `OrderSyncModule`：

```typescript
imports: [
  // ...
  OrderSyncModule,
  // ...
]
```

---

## 测试环境配置

### API配置信息

| 配置项 | 配置值 | 说明 |
|--------|--------|------|
| API地址 | `https://yx.vipstore.top/yoga/admin/getGoodsOrderList` | 海绵订单列表接口 |
| API密钥 | `12MfKhW5fQf6KoVlBRqR7Wm8Ma2fMtZT` | 接口访问密钥 |
| 默认销售ID | `1` | 外部订单默认分配的销售人员 |

### 同步配置建议

| 配置项 | 测试环境建议值 | 生产环境建议值 | 说明 |
|--------|---------------|---------------|------|
| 启用自动同步 | `false` | `true` | 测试时建议关闭自动同步 |
| 同步间隔 | `30分钟` | `5分钟` | 定时同步的时间间隔 |
| 增量同步天数 | `7天` | `7天` | 定时同步时拉取的天数范围 |
| 每日更新时间 | `02:00` | `02:00` | 批量更新订单状态的时间 |
| 批次大小 | `100` | `100` | 每次处理的订单数量 |
| 更新已存在订单 | `true` | `true` | 是否更新已同步的订单 |
| 同步客户信息 | `true` | `true` | 是否补充客户档案信息 |
| 自动创建校区 | `true` | `true` | 遇到新校区时自动创建 |

---

## 测试数据准备

### 执行测试数据脚本

使用提供的测试数据脚本创建测试客户：

```bash
# 方式1：通过MySQL客户端执行
mysql -u root -p crm_database < backend/test-order-sync.sql

# 方式2：登录MySQL后执行
mysql -u root -p
use crm_database;
source D:/CC/1.1/backend/test-order-sync.sql;
```

### 测试数据说明

脚本会创建以下测试客户：

| 客户姓名 | 微信号 | 手机号 | 已绑定订单号 | 用途 |
|---------|--------|--------|-------------|------|
| 测试客户-张三 | wx_zhangsan | 13800138001 | 20227343, 20228888 | 测试多订单绑定 |
| 测试客户-李四 | wx_lisi | 13800138002 | 20229999 | 测试单订单绑定 |
| 测试客户-王五 | wx_wangwu | 13800138003 | NULL | 测试未绑定订单情况 |

### 验证测试数据

```sql
-- 查看已创建的测试客户
SELECT
  id,
  real_name AS '姓名',
  phone AS '手机号',
  wechat_id AS '微信号',
  external_order_ids AS '已绑定订单号'
FROM customers
WHERE wechat_id LIKE 'wx_%'
  AND create_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
ORDER BY id DESC;
```

---

## 测试步骤

### 步骤1：访问订单同步配置页面

1. 登录CRM系统
2. 导航至：**订单管理 > 订单同步配置**
3. 路由地址：`/order/sync-config`

### 步骤2：检查基本配置

在**基本设置**标签页中：

1. ✅ 确认 **API密钥** 显示为：`12MfKhW5fQf6KoVlBRqR7Wm8Ma2fMtZT`
2. ✅ 确认 **API地址** 显示为：`https://yx.vipstore.top/yoga/admin/getGoodsOrderList`
3. ✅ 确认 **启用自动同步** 为**关闭**状态（测试阶段）
4. ✅ 确认 **默认销售人员** 已选择
5. ✅ 确认 **自动创建校区** 已开启

### 步骤3：查看客户订单绑定

在**客户绑定**标签页中：

1. ✅ 应该看到 **测试客户-张三** 绑定了 **2个订单号**（20227343, 20228888）
2. ✅ 应该看到 **测试客户-李四** 绑定了 **1个订单号**（20229999）
3. ✅ 可以使用搜索功能查找特定客户
4. ✅ 验证订单号显示格式正确

### 步骤4：执行手动同步

在**手动同步**标签页中：

1. 选择**时间范围**（建议选择最近30天）
2. 选择**订单状态**（建议选择"全部"）
3. 点击 **开始同步** 按钮
4. 观察同步进度提示

**预期结果**：
- 显示同步进度（如："正在同步，请稍候..."）
- 同步完成后显示统计信息：
  - ✅ 成功同步订单数量
  - ⚠️ 失败订单数量
  - 📊 总耗时

### 步骤5：查看同步日志

在**同步日志**标签页中：

1. ✅ 查看最新的同步记录
2. ✅ 筛选 **同步类型** = "手动同步"
3. ✅ 筛选 **同步结果** = "成功" 查看成功记录
4. ✅ 查看 **变更详情** 列，验证订单状态变化
5. ✅ 如有失败记录，查看 **错误信息** 列

**预期日志字段**：

| 字段 | 说明 | 示例值 |
|------|------|--------|
| 订单号 | 海绵系统订单编号 | 20227343 |
| 同步类型 | manual/interval/daily | manual |
| 同步结果 | 成功/失败 | 成功 |
| 旧状态 | 同步前订单状态 | 未支付 |
| 新状态 | 同步后订单状态 | 已支付 |
| 执行时长 | 单个订单处理耗时（毫秒） | 125ms |
| 变更详情 | 具体变更的字段 | status: 未支付 → 已支付 |

### 步骤6：验证订单列表显示

导航至：**订单管理 > 订单列表** (`/order/list`)

#### 6.1 验证数据来源筛选

1. ✅ 在搜索栏找到 **数据来源** 下拉框
2. ✅ 验证选项包含：
   - 手工录入
   - 小程序导入
   - 海绵青年GO
3. ✅ 选择 "海绵青年GO" 进行筛选
4. ✅ 点击 **查询** 按钮

#### 6.2 验证数据来源列显示

在订单列表表格中：

1. ✅ 找到 **数据来源** 列
2. ✅ 验证同步的订单显示为：
   - 蓝色深色标签："海绵青年GO"
3. ✅ 验证手工录入订单显示为：
   - 灰色标签："手工录入"
4. ✅ 验证小程序订单显示为：
   - 绿色标签："小程序导入"

#### 6.3 验证同步状态列显示

在订单列表表格中：

1. ✅ 找到 **同步状态** 列
2. ✅ 验证外部订单（is_external=1）显示状态标签：
   - ✅ 绿色标签："已同步"
   - ⚠️ 黄色标签："同步中"
   - ❌ 红色标签："同步失败"
3. ✅ 验证非外部订单显示 "-" 符号（灰色文本）

### 步骤7：验证订单详情

点击某个海绵订单的**查看详情**：

1. ✅ 确认 **数据来源** 字段显示 "海绵青年GO"
2. ✅ 确认 **外部订单号** 字段有值
3. ✅ 确认 **外部系统** 字段显示 "海绵青年GO"
4. ✅ 确认 **同步状态** 正确显示
5. ✅ 确认 **最后同步时间** 有具体时间戳

---

## 验收标准

### 功能验收

| 验收项 | 验收标准 | 优先级 |
|--------|---------|--------|
| 订单同步成功 | 能够成功同步海绵系统订单到本地 | P0 |
| 客户关联正确 | 订单正确关联到绑定了external_order_ids的客户 | P0 |
| 状态映射准确 | 海绵订单状态正确映射到本地订单状态 | P0 |
| 数据来源筛选 | 能够按数据来源筛选订单 | P0 |
| 同步状态显示 | 外部订单正确显示同步状态 | P0 |
| 日志记录完整 | 每次同步都有详细日志记录 | P1 |
| 错误处理合理 | 同步失败时有明确错误提示 | P1 |
| 配置修改生效 | 修改配置后能够立即生效 | P1 |

### 性能验收

| 验收项 | 验收标准 |
|--------|---------|
| 单次同步速度 | 100个订单 < 30秒 |
| 页面加载速度 | 订单列表首次加载 < 2秒 |
| 筛选响应速度 | 数据来源筛选 < 500ms |

### UI验收

| 验收项 | 验收标准 |
|--------|---------|
| 标签颜色规范 | 海绵订单用蓝色深色效果 |
| 同步状态清晰 | 成功/失败/进行中有明显区分 |
| 非外部订单显示 | 同步状态列显示 "-" 而不是空白 |
| 响应式布局 | 在不同屏幕尺寸下正常显示 |

---

## 常见问题排查

### Q1: 同步失败提示"未找到关联客户"

**原因**：订单号未绑定到任何客户的 `external_order_ids` 字段

**解决方案**：

```sql
-- 检查客户是否绑定了对应订单号
SELECT
  id,
  real_name,
  external_order_ids
FROM customers
WHERE JSON_CONTAINS(external_order_ids, '"20227343"');

-- 如果未绑定，手动绑定订单号到客户
UPDATE customers
SET external_order_ids = JSON_ARRAY('20227343', '20228888')
WHERE id = 123;  -- 替换为实际客户ID
```

### Q2: 订单列表看不到同步的订单

**排查步骤**：

1. **检查同步日志是否显示成功**
   ```sql
   SELECT * FROM order_sync_logs
   WHERE result = '成功'
   ORDER BY sync_time DESC
   LIMIT 10;
   ```

2. **刷新订单列表页面**（可能是缓存问题）

3. **使用数据来源筛选**
   - 在订单列表顶部搜索栏
   - 选择 "数据来源" = "海绵青年GO"
   - 点击查询

4. **直接查询数据库验证**
   ```sql
   SELECT * FROM orders
   WHERE data_source = '海绵青年GO'
   ORDER BY create_time DESC
   LIMIT 10;
   ```

### Q3: API调用失败

**可能原因及解决方案**：

| 原因 | 排查方法 | 解决方案 |
|------|---------|---------|
| 网络不通 | `ping yx.vipstore.top` | 检查网络连接和防火墙 |
| API密钥错误 | 查看错误日志中的响应码 | 在配置页面更新正确的密钥 |
| API地址错误 | 浏览器访问API地址测试 | 确认API地址格式正确 |
| 服务端限流 | 查看是否返回429错误 | 降低同步频率 |

**查看详细错误日志**：

```sql
SELECT
  order_no,
  error_message,
  external_data,
  sync_time
FROM order_sync_logs
WHERE result = '失败'
ORDER BY sync_time DESC
LIMIT 20;
```

### Q4: 校区不存在导致同步失败

**错误信息示例**：`校区"XX校区"不存在`

**解决方案**：

1. **方案1：开启自动创建校区**
   - 进入 订单同步配置 > 基本设置
   - 开启 "自动创建校区" 选项
   - 重新执行同步

2. **方案2：手动创建校区**
   ```sql
   INSERT INTO campuses (name, address, status, create_time)
   VALUES ('XX校区', '具体地址', 1, NOW());
   ```

### Q5: 同步状态列显示不正确

**排查清单**：

- ✅ 检查订单的 `is_external` 字段是否为 1
  ```sql
  SELECT id, order_no, is_external, sync_status, data_source
  FROM orders
  WHERE order_no = '20227343';
  ```

- ✅ 检查前端代码中的条件判断
  ```javascript
  // 应该使用严格相等判断
  row.isExternal === 1
  ```

- ✅ 清除浏览器缓存并刷新页面

### Q6: 定时任务未自动运行

**排查步骤**：

1. **检查配置是否启用**
   ```sql
   SELECT config_value
   FROM business_config
   WHERE config_key = 'order_sync.enabled';
   ```
   应该返回 `'true'`

2. **检查后端日志**
   ```bash
   # 查看 NestJS 应用日志
   cd backend
   npm run start:dev

   # 应该看到类似的定时任务日志：
   # [OrderSyncScheduler] Starting incremental sync...
   # [OrderSyncScheduler] Incremental sync completed: 5 success, 0 failed
   ```

3. **验证 @nestjs/schedule 包已安装**
   ```bash
   cd backend
   npm list @nestjs/schedule
   ```

4. **检查 app.module.ts 中的 ScheduleModule**
   ```typescript
   imports: [
     ScheduleModule.forRoot(),  // 必须导入
     // ...
   ]
   ```

### Q7: 同步的订单缺少客户信息

**可能原因**：

- 客户未绑定订单号
- 订单号格式不匹配
- JSON字段查询问题

**解决方案**：

```sql
-- 检查订单号绑定情况
SELECT
  c.id AS customer_id,
  c.real_name,
  c.external_order_ids,
  o.id AS order_id,
  o.order_no,
  o.customer_id AS order_customer_id
FROM customers c
LEFT JOIN orders o ON JSON_CONTAINS(c.external_order_ids, CONCAT('"', o.order_no, '"'))
WHERE c.external_order_ids IS NOT NULL
ORDER BY c.id DESC;

-- 重新绑定客户和订单的关系
UPDATE orders o
INNER JOIN customers c ON JSON_CONTAINS(c.external_order_ids, CONCAT('"', o.order_no, '"'))
SET o.customer_id = c.id,
    o.customer_name = c.real_name,
    o.customer_phone = c.phone
WHERE o.data_source = '海绵青年GO'
  AND o.is_external = 1;
```

---

## 清理测试数据

### 谨慎操作警告

⚠️ **以下操作会删除数据，请在测试环境执行，生产环境请谨慎！**

### 清理测试客户

```sql
-- 删除测试客户（仅删除最近1小时创建的测试客户）
DELETE FROM customers
WHERE wechat_id LIKE 'wx_%'
  AND create_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

### 清理测试订单

```sql
-- 删除测试订单（仅删除最近1小时创建的外部订单）
DELETE FROM orders
WHERE data_source = '海绵青年GO'
  AND create_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

### 清理同步日志

```sql
-- 删除测试同步日志（仅删除最近1小时的日志）
DELETE FROM order_sync_logs
WHERE sync_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

### 批量清理脚本

```sql
-- 一键清理所有测试数据（谨慎执行）
START TRANSACTION;

DELETE FROM order_sync_logs
WHERE sync_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);

DELETE FROM orders
WHERE data_source = '海绵青年GO'
  AND create_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);

DELETE FROM customers
WHERE wechat_id LIKE 'wx_%'
  AND create_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);

-- 检查删除结果，确认无误后提交
-- COMMIT;

-- 如果发现误删，立即回滚
-- ROLLBACK;
```

---

## 附录

### A. 订单状态映射表

| 海绵系统状态码 | 海绵系统状态名 | CRM系统状态 |
|---------------|---------------|------------|
| 1 | 未支付 | 未支付（不同步） |
| 2 | 已支付 | 已支付 |
| 3 | 已使用 | 已完成 |
| 4 | 已退款 | 已退款 |
| 5 | 已过期 | 已取消 |

### B. 关键API接口

#### 获取订单列表

**接口地址**：`https://yx.vipstore.top/yoga/admin/getGoodsOrderList`

**请求方法**：GET

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| key | string | 是 | API密钥 |
| start_time | string | 否 | 开始时间（格式：YYYY-MM-DD HH:mm:ss） |
| end_time | string | 否 | 结束时间 |
| status | number | 否 | 订单状态（1-5） |
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页数量，默认20 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "order_no": "20227343",
        "product_name": "瑜伽私教课",
        "price": 299.00,
        "status": 2,
        "buyer_name": "张三",
        "buyer_phone": "13800138001",
        "campus_name": "世纪金源校区",
        "create_time": "2024-11-20 14:30:00",
        "pay_time": "2024-11-20 14:35:00"
      }
    ],
    "total": 150,
    "page": 1,
    "limit": 20
  }
}
```

### C. 相关文件路径

#### 后端文件

| 文件路径 | 说明 |
|---------|------|
| `backend/src/modules/order-sync/order-sync.service.ts` | 核心同步服务 |
| `backend/src/modules/order-sync/order-sync.controller.ts` | API控制器 |
| `backend/src/modules/order-sync/haimian-api.service.ts` | 海绵API调用服务 |
| `backend/src/modules/order-sync/order-sync.scheduler.ts` | 定时任务调度器 |
| `backend/src/modules/order-sync/entities/order-sync-log.entity.ts` | 同步日志实体 |
| `backend/src/migrations/1731575000000-AddOrderSyncFields.sql` | 数据库迁移脚本 |
| `backend/test-order-sync.sql` | 测试数据脚本 |

#### 前端文件

| 文件路径 | 说明 |
|---------|------|
| `frontend/src/views/order/SyncConfig.vue` | 订单同步配置页面 |
| `frontend/src/views/order/List.vue` | 订单列表页面 |
| `frontend/src/api/order-sync.ts` | 订单同步API接口 |

### D. 数据库表结构

#### customers 表新增字段

```sql
ALTER TABLE customers ADD COLUMN external_order_ids JSON COMMENT '外部订单号列表（JSON数组）';
```

#### orders 表新增字段

```sql
ALTER TABLE orders ADD COLUMN is_external TINYINT DEFAULT 0 COMMENT '是否外部订单：1-是，0-否';
ALTER TABLE orders ADD COLUMN external_system VARCHAR(50) COMMENT '外部系统名称';
ALTER TABLE orders ADD COLUMN external_order_no VARCHAR(100) COMMENT '外部订单号';
ALTER TABLE orders ADD COLUMN sync_status VARCHAR(20) COMMENT '同步状态：已同步、同步中、同步失败';
ALTER TABLE orders ADD COLUMN last_sync_time DATETIME COMMENT '最后同步时间';
ALTER TABLE orders ADD COLUMN data_source VARCHAR(50) COMMENT '数据来源：手工录入、小程序导入、海绵青年GO';
```

#### order_sync_logs 表结构

```sql
CREATE TABLE order_sync_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  sync_batch_id VARCHAR(50) COMMENT '同步批次ID',
  order_no VARCHAR(100) COMMENT '订单号',
  sync_type VARCHAR(20) COMMENT '同步类型：manual、interval、daily',
  old_status VARCHAR(50) COMMENT '同步前状态',
  new_status VARCHAR(50) COMMENT '同步后状态',
  changes TEXT COMMENT '变更详情（JSON）',
  external_data TEXT COMMENT '外部系统原始数据（JSON）',
  result VARCHAR(20) COMMENT '同步结果：成功、失败',
  error_message TEXT COMMENT '错误信息',
  execution_time INT COMMENT '执行耗时（毫秒）',
  sync_time DATETIME COMMENT '同步时间',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| v1.0 | 2024-11-21 | 初始版本，完整测试文档 | Claude |

---

**文档结束**

如有问题，请联系技术支持或查看源码注释。
